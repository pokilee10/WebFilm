<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Danh s√°ch phim</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  
  <style>
    .movie-card { margin-bottom: 30px; }
    .like-btn { background-color: #ff4081; color: white; border: none; padding: 5px 15px; border-radius: 5px; }
  </style>
  <div class="mb-4">
  <label for="genreFilter" class="form-label">üéØ L·ªçc theo th·ªÉ lo·∫°i:</label>
  <select id="genreFilter" class="form-select">
    <option value="">-- T·∫•t c·∫£ --</option>
  </select>
</div>
<!-- Firebase App (core) -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<!-- Firebase Auth -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<!-- Firebase Database -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

</head>
<body class="container py-4">

  <h1 class="mb-4">üé¨ Danh s√°ch phim</h1>

  <!-- ƒêƒÉng nh·∫≠p/ƒêƒÉng k√Ω -->
<div id="authSection" class="mb-4">
  <div id="userInfo" style="display:none;">
    üë§ Xin ch√†o, <span id="userEmail"></span>
    <button class="btn btn-sm btn-danger" onclick="logout()">ƒêƒÉng xu·∫•t</button>
  </div>
  <div id="authForms">
    <input type="email" id="email" class="form-control mb-2" placeholder="Email">
    <input type="password" id="password" class="form-control mb-2" placeholder="M·∫≠t kh·∫©u">
    <button class="btn btn-primary mb-1" onclick="login()">ƒêƒÉng nh·∫≠p</button>
    <button class="btn btn-secondary" onclick="register()">ƒêƒÉng k√Ω</button>
  </div>
</div>


  <!-- N√∫t upload CSV -->
  <div class="mb-4">
    <label for="csvFile" class="form-label">üìÇ T·∫£i file CSV danh s√°ch phim:</label>
    <input type="file" id="csvFile" accept=".csv" class="form-control">
  </div>

  <!-- Khu v·ª±c hi·ªÉn th·ªã danh s√°ch phim -->
  <div class="row" id="movieList">
    <!-- C√°c phim s·∫Ω ƒë∆∞·ª£c hi·ªÉn th·ªã ·ªü ƒë√¢y -->
  </div>

  <script>
    // ==== Thay b·∫±ng c·∫•u h√¨nh Firebase c·ªßa b·∫°n ===================================================================
    // Import the functions you need from the SDKs you need

    // TODO: Add SDKs for Firebase products that you want to use

    // https://firebase.google.com/docs/web/setup#available-libraries


    // Your web app's Firebase configuration

    // For Firebase JS SDK v7.20.0 and later, measurementId is optional

    const firebaseConfig = {
    apiKey: "AIzaSyDGn25lfLVLX2eahI41LTLFx9whEZrgRIk",
    authDomain: "web-phim-6b76c.firebaseapp.com",
    databaseURL: "https://web-phim-6b76c-default-rtdb.asia-southeast1.firebasedatabase.app", // <-- ƒê√öNG!
    projectId: "web-phim-6b76c",
    storageBucket: "web-phim-6b76c.appspot.com", // <-- ƒê√öNG!
    messagingSenderId: "676922439385",
    appId: "1:676922439385:web:476eea9d5265771ce230c8",
    measurementId: "G-B6Y0DSKFV2"
  };



    // Initialize Firebase

    firebase.initializeApp(firebaseConfig);
    // N·∫øu b·∫°n kh√¥ng d√πng analytics th√¨ c√≥ th·ªÉ b·ªè qua d√≤ng n√†y
    // firebase.analytics();
    const auth = firebase.auth();
    const db = firebase.database();
    let currentUser = null;


// ============================================================================================
  function register() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    auth.createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        alert('ƒêƒÉng k√Ω th√†nh c√¥ng!');
      })
      .catch(e => alert(e.message));
  }

  function login() {
    const email = document.getElementById('email').value;
    const password = document.getElementById('password').value;
    auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        alert('ƒêƒÉng nh·∫≠p th√†nh c√¥ng!');
      })
      .catch(e => alert(e.message));
  }

  function logout() {
    auth.signOut();
    alert('ƒê√£ ƒëƒÉng xu·∫•t!');
  }

  auth.onAuthStateChanged(user => {
    currentUser = user;
    if (user) {
      document.getElementById('userInfo').style.display = '';
      document.getElementById('userEmail').innerText = user.email;
      document.getElementById('authForms').style.display = 'none';
    } else {
      document.getElementById('userInfo').style.display = 'none';
      document.getElementById('authForms').style.display = '';
    }
  });
// ===================================================================
  let allMovies = [];
  document.getElementById('csvFile').addEventListener('change', function (e) {
    const file = e.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = function (event) {
      const text = event.target.result;
      const movies = parseCSV(text);
      renderMovies(movies);
    };
    reader.readAsText(file);
  });

  function parseCSV(csvText) {
    const lines = csvText.trim().split('\n');
    const headers = parseCSVLine(lines[0]);
    const movies = [];

    for (let i = 1; i < lines.length; i++) {
      const values = parseCSVLine(lines[i]);
      const movie = {};
      headers.forEach((header, index) => {
        movie[header] = values[index] || '';
      });

      // ‚úÖ X·ª≠ l√Ω JSON trong tr∆∞·ªùng genres
      try {
        const genresRaw = movie.genres.replace(/""/g, '"');
        const genres = JSON.parse(genresRaw);
        movie.genres_str = Array.isArray(genres)
          ? genres.map(g => g.name).join(', ')
          : '';
      } catch (e) {
        movie.genres_str = movie.genres;
      }

      movie.title = movie.title || movie.original_title || `Phim #${i}`;
      movie.release_date = movie.release_date || '';
      movie.vote_average = movie.vote_average || '';
      movie.overview = movie.overview || '';

      movies.push(movie);
    }

    return movies;
  }

  // ‚úÖ H√†m t√°ch d√≤ng CSV c√≥ d·∫•u nh√°y v√† d·∫•u ph·∫©y b√™n trong
  function parseCSVLine(line) {
    const result = [];
    let current = '';
    let inQuotes = false;

    for (let i = 0; i < line.length; i++) {
      const char = line[i];
      const nextChar = line[i + 1];

      if (char === '"' && inQuotes && nextChar === '"') {
        current += '"';
        i++;
      } else if (char === '"') {
        inQuotes = !inQuotes;
      } else if (char === ',' && !inQuotes) {
        result.push(current);
        current = '';
      } else {
        current += char;
      }
    }
    result.push(current);
    return result;
  }

  function renderMovies(movies) {
  const container = document.getElementById('movieList');
  container.innerHTML = '';

  // L∆∞u l·∫°i danh s√°ch phim ƒë·∫ßy ƒë·ªß
  allMovies = movies;

  // L·∫•y danh s√°ch th·ªÉ lo·∫°i duy nh·∫•t
  const genreSet = new Set();
  movies.forEach(movie => {
    if (movie.genres_str) {
      movie.genres_str.split(',').forEach(g => genreSet.add(g.trim()));
    }
  });

  // ƒê·ªï dropdown th·ªÉ lo·∫°i
  const genreFilter = document.getElementById('genreFilter');
  genreFilter.innerHTML = `<option value="">-- T·∫•t c·∫£ --</option>`;
  Array.from(genreSet).sort().forEach(genre => {
    genreFilter.innerHTML += `<option value="${genre}">${genre}</option>`;
  });

  // G·∫Øn s·ª± ki·ªán l·ªçc
  genreFilter.onchange = () => filterByGenre(genreFilter.value);

  // Hi·ªÉn th·ªã t·∫•t c·∫£ phim ban ƒë·∫ßu
  renderMovieList(movies);
}

function renderMovieList(movies) {
  const container = document.getElementById('movieList');
  container.innerHTML = '';

  movies.forEach(movie => {
    const col = document.createElement('div');
    col.className = 'col-md-6 movie-card';
    col.innerHTML = `
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">${movie.title}</h5>
          <p><strong>Th·ªÉ lo·∫°i:</strong> ${movie.genres_str}</p>
          <p><strong>Ng√†y ph√°t h√†nh:</strong> ${movie.release_date}</p>
          <p><strong>ƒêi·ªÉm ƒë√°nh gi√°:</strong> ${movie.vote_average}</p>
          <p>${movie.overview}</p>
          <button class="like-btn" onclick="likeMovie('${movie.title}')">üëç Th√≠ch</button>
        </div>
      </div>
    `;
    container.appendChild(col);
  });
}

function filterByGenre(genre) {
  if (!genre) {
    renderMovieList(allMovies);
    return;
  }
  const filtered = allMovies.filter(movie =>
    movie.genres_str.split(',').map(g => g.trim()).includes(genre)
  );
  renderMovieList(filtered);
}

function likeMovie(title) {
  if (!currentUser) {
    alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch phim!');
    return;
  }
  alert("B·∫°n ƒë√£ th√≠ch phim: " + title);
  // L∆∞u l√™n Firebase: /users/{uid}/liked_movies
  const userId = currentUser.uid;
  const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
  userMoviesRef.once('value').then(snapshot => {
    let liked = snapshot.val() || [];
    if (!liked.includes(title)) {
      liked.push(title);
      userMoviesRef.set(liked);
    }
  });
}

// function sendUserDataToServer() {
//   if (!currentUser) return;
//   const userId = currentUser.uid;
//   db.ref('users/' + userId + '/liked_movies').once('value').then(snapshot => {
//     const likedMovies = snapshot.val() || [];
//     // G·ª≠i d·ªØ li·ªáu n√†y l√™n server c·ªßa b·∫°n qua fetch/AJAX
//     fetch('https://your-server.com/api/receive', {
//       method: 'POST',
//       headers: {'Content-Type': 'application/json'},
//       body: JSON.stringify({userId, likedMovies})
//     });
//   });
// }

</script>
<style>
  .movie-card {
    margin-bottom: 30px;
    display: flex;
  }
  .card {
    flex: 1;
    display: flex;
    flex-direction: column;
    height: 100%;
  }
  .card-body {
    flex: 1;
    display: flex;
    flex-direction: column;
  }
  .card-title {
    font-weight: bold;
    font-size: 1.25rem;
  }
  .card p {
    margin-bottom: 0.5rem;
  }
  .like-btn {
    background-color: #ff4081;
    color: white;
    border: none;
    padding: 5px 15px;
    border-radius: 5px;
    margin-top: auto;
    align-self: start;
  }
</style>


</body>
</html>
