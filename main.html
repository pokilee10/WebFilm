<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>Web Phim Si√™u ƒê·∫πp</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container py-4">
        <div class="main-title">
            <i class="bi bi-film"></i> Web Phim Si√™u ƒê·∫πp
        </div>
        <div class="user-info mb-3" id="userInfo" style="display:none;">
            üë§ Xin ch√†o, <span id="userEmail"></span>
            <button class="logout-btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
        <div class="filter-bar row align-items-center mb-3">
            <div class="col-md-6">
                <label for="genreFilter" class="form-label mb-1">L·ªçc theo th·ªÉ lo·∫°i:</label>
                <select id="genreFilter" class="form-select">
                    <option value="">-- T·∫•t c·∫£ --</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="searchInput" class="form-label mb-1">T√¨m ki·∫øm phim:</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Nh·∫≠p t√™n phim...">
            </div>
        </div>
        <div class="row mt-3" id="movieList"></div>

        <!-- Phim g·ª£i √Ω sau khi th√≠ch -->
        <div id="recommendationsSection" class="mt-5" style="display:none;">
            <h4>Phim G·ª£i √ù</h4>
            <div class="row" id="recommendationsList"></div>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDGn25lfLVLX2eahI41LTLFx9whEZrgRIk",
            authDomain: "web-phim-6b76c.firebaseapp.com",
            databaseURL: "https://web-phim-6b76c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "web-phim-6b76c",
            storageBucket: "web-phim-6b76c.appspot.com",
            messagingSenderId: "676922439385",
            appId: "1:676922439385:web:476eea9d5265771ce230c8",
            measurementId: "G-B6Y0DSKFV2"
        };

        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let allMovies = [];

        const S3_CSV_URL = "https://lxl-bucket.s3.ap-southeast-1.amazonaws.com/tmdb_5000_movies.csv";
        const API_RECOMMEND_URL = "https://qrvat15p0k.execute-api.ap-southeast-1.amazonaws.com/default/film-recommend-system";

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (!user) {
                window.location.href = "login.html";
            } else {
                document.getElementById('userInfo').style.display = '';
                document.getElementById('userEmail').innerText = user.email;
                fetchCSVFromS3();
            }
        });

        function logout() {
            auth.signOut();
            alert('ƒê√£ ƒëƒÉng xu·∫•t!');
            window.location.href = "login.html";
        }

        function fetchCSVFromS3() {
            fetch(S3_CSV_URL)
                .then(res => res.text())
                .then(csvText => {
                    const movies = parseCSV(csvText);
                    allMovies = movies;
                    renderMovies(allMovies.slice(0, 20));
                })
                .catch(err => {
                    document.getElementById('movieList').innerHTML = `<div class="alert alert-danger">L·ªói t·∫£i d·ªØ li·ªáu: ${err.message}</div>`;
                });
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            const movies = [];
            for (let i = 1; i < lines.length; i++) {
                const values = parseCSVLine(lines[i]);
                const movie = {};
                headers.forEach((header, index) => {
                    movie[header] = values[index] || '';
                });
                try {
                    const genresRaw = movie.genres.replace(/""/g, '"');
                    const genres = JSON.parse(genresRaw);
                    movie.genres_str = Array.isArray(genres)
                        ? genres.map(g => g.name).join(', ')
                        : '';
                } catch (e) {
                    movie.genres_str = movie.genres;
                }
                movie.title = movie.title || movie.original_title || `Phim #${i}`;
                movies.push(movie);
            }
            return movies;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                if (char === '"' && inQuotes && nextChar === '"') {
                    current += '"';
                    i++;
                } else if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        function renderMovies(movies) {
            const genreSet = new Set();
            movies.forEach(movie => {
                if (movie.genres_str) {
                    movie.genres_str.split(',').forEach(g => genreSet.add(g.trim()));
                }
            });

            const genreFilter = document.getElementById('genreFilter');
            genreFilter.innerHTML = `<option value="">-- T·∫•t c·∫£ --</option>`;
            Array.from(genreSet).sort().forEach(genre => {
                genreFilter.innerHTML += `<option value="${genre}">${genre}</option>`;
            });
            genreFilter.onchange = () => filterAndSearch();

            document.getElementById('searchInput').oninput = () => filterAndSearch();

            renderMovieList(movies);
        }

        function renderMovieList(movies) {
            const container = document.getElementById('movieList');
            container.innerHTML = '';
            movies.forEach(movie => {
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 movie-card';
                col.innerHTML = `
                    <div class="card shadow-sm h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title">${movie.title}</h5>
                            <p><strong>Th·ªÉ lo·∫°i:</strong> ${movie.genres_str}</p>
                            <p><strong>Ng√†y ph√°t h√†nh:</strong> ${movie.release_date}</p>
                            <p><strong>ƒêi·ªÉm ƒë√°nh gi√°:</strong> <span class="text-warning">${movie.vote_average}</span></p>
                            <p>${movie.overview}</p>
                            <button class="like-btn mt-auto" onclick="likeMovie('${movie.title.replace(/'/g, "\\'")}')">
                                Th√≠ch
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        function filterAndSearch() {
            const genre = document.getElementById('genreFilter').value.trim();
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            const filtered = allMovies.filter(movie => {
                const matchGenre = !genre || movie.genres_str.split(',').map(g => g.trim()).includes(genre);
                const matchKeyword = !keyword || movie.title.toLowerCase().includes(keyword);
                return matchGenre && matchKeyword;
            });
            renderMovieList(filtered.slice(0, 20));
        }

        function likeMovie(title) {
    if (!currentUser) {
        alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch phim!');
        return;
    }

    console.log("G·ª≠i y√™u c·∫ßu g·ª£i √Ω cho phim:", title);

    fetch(API_RECOMMEND_URL, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ movie_name: title })
    })
    .then(res => res.json())
    .then(data => {
        const recommendedTitles = data.recommendations || [];
        console.log("Phim g·ª£i √Ω:", recommendedTitles);

        const section = document.getElementById('recommendationsSection');
        const listContainer = document.getElementById('recommendationsList');
        listContainer.innerHTML = '';

        if (recommendedTitles.length > 0) {
            section.style.display = 'block';

            // L·ªçc c√°c phim t·ª´ allMovies c√≥ t√™n tr√πng v·ªõi g·ª£i √Ω
            const matchedMovies = allMovies.filter(movie =>
                recommendedTitles.includes(movie.title)
            );

            // N·∫øu kh√¥ng match g√¨, hi·ªÉn th·ªã b·∫±ng t√™n
            if (matchedMovies.length === 0) {
                recommendedTitles.forEach(title => {
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4';
                    card.innerHTML = `
                        <div class="card shadow-sm mb-3 h-100">
                            <div class="card-body">
                                <h5 class="card-title">${title}</h5>
                                <p><em>Kh√¥ng t√¨m th·∫•y th√¥ng tin chi ti·∫øt.</em></p>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            } else {
                matchedMovies.forEach(movie => {
                    const card = document.createElement('div');
                    card.className = 'col-md-6 col-lg-4';
                    card.innerHTML = `
                        <div class="card shadow-sm mb-3 h-100">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title">${movie.title}</h5>
                                <p><strong>Th·ªÉ lo·∫°i:</strong> ${movie.genres_str}</p>
                                <p><strong>Ng√†y ph√°t h√†nh:</strong> ${movie.release_date}</p>
                                <p><strong>ƒêi·ªÉm ƒë√°nh gi√°:</strong> <span class="text-warning">${movie.vote_average}</span></p>
                                <p>${movie.overview}</p>
                            </div>
                        </div>
                    `;
                    listContainer.appendChild(card);
                });
            }

        } else {
            section.style.display = 'none';
        }

        // Ghi l·∫°i phim ƒë√£ th√≠ch trong Firebase
        const userId = currentUser.uid;
        const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
        userMoviesRef.once('value').then(snapshot => {
            let liked = snapshot.val() || [];
            if (!liked.includes(title)) {
                liked.push(title);
                userMoviesRef.set(liked);
            }
        });
    })
    .catch(err => {
        console.error("L·ªói khi g·ªçi API:", err);
        alert("Kh√¥ng th·ªÉ l·∫•y phim g·ª£i √Ω.");
    });
}


        window.onload = function() {
            if (currentUser) {
                fetchCSVFromS3();
            }
        };
    </script>
</body>
</html>
