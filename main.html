<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>KLiHoKa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5, Bootstrap Icons, Google Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
    <!-- Header & Navbar -->
    <header class="header-area">
        <nav class="navbar navbar-expand-lg">
            <div class="container">
                <a class="navbar-brand" href="#">
                    <i class="bi bi-film"></i> KLiHoKa
                </a>
                <div class="user-area ms-auto" id="userInfo" style="display:none;">
                    <div class="d-flex align-items-center">
                        <div class="user-welcome me-3">
                            <span class="user-icon"><i class="bi bi-person-circle"></i></span>
                            <span id="userEmail"></span>
                        </div>
                        <button class="btn btn-favorites me-2" id="favoritesBtn" onclick="showFavorites()">
                            <i class="bi bi-heart-fill"></i> Phim đã thích
                        </button>
                        <button class="btn-logout" onclick="logout()">
                            <i class="bi bi-box-arrow-right"></i>
                            <span class="d-none d-md-inline">Đăng xuất</span>
                        </button>
                    </div>
                </div>
            </div>
        </nav>
    </header>
    
    <div class="container main-container py-4">
        <!-- Container phim đã thích - Mặc định ẩn -->
        <div id="favoritesContainer" class="mb-4" style="display:none;">
            <div class="favorites-header d-flex justify-content-between align-items-center mb-3">
                <h3 class="favorites-title"><i class="bi bi-heart-fill text-danger"></i> Phim Đã Thích</h3>
                <button class="btn btn-sm btn-outline-light" onclick="hideFavorites()">
                    <i class="bi bi-x-lg"></i> Đóng
                </button>
            </div>
            <div id="favoritesList" class="row">
                <!-- Nội dung phim đã thích sẽ được render ở đây -->
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2">Đang tải danh sách phim đã thích...</p>
                </div>
            </div>
        </div>

        <!-- Filter and search section -->
        <div class="search-filter-container">
            <div class="row g-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-center mb-3">
                        <h5 class="filter-title mb-0"><i class="bi bi-funnel-fill"></i> Lọc theo thể loại</h5>
                        <div class="d-flex align-items-center">
                            <div class="input-group search-input-group">
                                <input type="text" id="searchInput" class="form-control" placeholder="Tìm kiếm phim...">
                                <span class="input-group-text"><i class="bi bi-search"></i></span>
                            </div>
                        </div>
                    </div>
                    <div class="genre-filters-wrapper">
                        <div id="genreFilterButtons" class="genre-filter-container">
                            <div class="d-flex flex-wrap gap-2">
                                <button class="genre-badge active" data-genre="">Tất cả</button>
                                <!-- Các thể loại sẽ được thêm ở đây bằng JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Movie grid -->
        <div class="row mt-4 gy-4" id="movieList"></div>
        
        <!-- Pagination -->
        <div id="pagination" class="d-flex justify-content-center my-4">
            <button id="prevPage" class="btn btn-outline-primary me-2"><i class="bi bi-arrow-left"></i> Trang trước</button>
            <div id="pageInfo" class="btn btn-light disabled">Trang <span id="currentPage">1</span> / <span id="totalPages">1</span></div>
            <button id="nextPage" class="btn btn-outline-primary ms-2">Trang sau <i class="bi bi-arrow-right"></i></button>
        </div>
    </div>

    <!-- Modal Recommend -->
    <div class="modal fade" id="recommendModal" tabindex="-1" aria-labelledby="recommendModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header" style="background: linear-gradient(90deg, #ff4081 60%, #ff8c00 100%); color: #fff;">
            <h5 class="modal-title" id="recommendModalLabel"><i class="bi bi-stars"></i> Phim Gợi Ý Cho Bạn</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
          </div>
          <div class="modal-body" id="recommendContent">
            <!-- Nội dung phim gợi ý sẽ được render ở đây -->
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Chi Tiết Phim -->
    <div class="modal fade" id="movieDetailModal" tabindex="-1" aria-labelledby="movieDetailModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title" id="movieDetailModalLabel"><i class="bi bi-film"></i> Chi Tiết Phim</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
          </div>
          <div class="modal-body" id="movieDetailContent">
            <div class="text-center">
              <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Đang tải...</span>
              </div>
              <p>Đang tải thông tin phim...</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (để cuối body, cho modal hoạt động) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* Main styling */
        :root {
            --primary-color: #ff4081;
            --secondary-color: #ff8c00;
            --dark-bg: #121212;
            --card-bg: #1e1e1e;
            --light-text: #f8f9fa;
            --medium-text: #b0b0b0;
            --border-radius: 12px;
            --card-shadow: 0 8px 16px rgba(0, 0, 0, 0.2);
            --badge-shadow: 0 4px 8px rgba(255, 64, 129, 0.25);
            --button-shadow: 0 4px 12px rgba(255, 64, 129, 0.3);
        }
        
        body {
            background: linear-gradient(135deg, #0f0c29, #1f1b32, #24243e);
            color: var(--light-text);
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            line-height: 1.6;
            background-attachment: fixed;
        }
        
        /* Header and Navbar */
        .header-area {
            background: rgba(30, 30, 30, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 4px 30px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
            padding: 15px 0;
            margin-bottom: 30px;
        }
        
        .navbar-brand {
            font-family: 'Montserrat', sans-serif;
            font-size: 28px;
            font-weight: 700;
            color: var(--light-text);
            background: linear-gradient(90deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: inline-block;
            transition: all 0.3s ease;
        }
        
        .navbar-brand i {
            margin-right: 5px;
            color: var(--primary-color);
        }
        
        .user-area {
            display: flex;
            align-items: center;
        }
        
        .user-welcome {
            display: flex;
            align-items: center;
            color: var(--light-text);
            font-size: 14px;
        }
        
        .user-icon {
            font-size: 24px;
            margin-right: 10px;
            color: var(--primary-color);
        }
        
        /* Main container */
        .main-container {
            background: rgba(30, 30, 30, 0.5);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            box-shadow: var(--card-shadow);
            padding: 30px;
            margin-top: 20px;
            margin-bottom: 40px;
        }
        
        /* Button styling */
        .btn-favorites {
            background: linear-gradient(90deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 600;
            transition: 0.3s;
            box-shadow: var(--button-shadow);
        }
        
        .btn-favorites:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(255, 64, 129, 0.4);
            color: white;
        }
        
        .btn-logout {
            background: rgba(220, 53, 69, 0.2);
            color: #fff;
            border: 1px solid rgba(220, 53, 69, 0.4);
            padding: 10px 20px;
            border-radius: 30px;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-logout:hover {
            background: rgba(220, 53, 69, 0.8);
            transform: translateY(-3px);
            box-shadow: 0 4px 10px rgba(220, 53, 69, 0.3);
        }
        
        /* Search and Filter section */
        .search-filter-container {
            background: rgba(25, 25, 25, 0.8);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .filter-title {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-right: 15px;
        }
        
        .genre-filters-wrapper {
            position: relative;
            background: rgba(15, 15, 15, 0.5);
            border-radius: 10px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .genre-filter-container {
            overflow-x: auto;
            padding-bottom: 5px;
            scrollbar-width: thin;
            scrollbar-color: var(--primary-color) var(--card-bg);
            max-width: 100%;
        }
        
        .genre-filter-container::-webkit-scrollbar {
            height: 5px;
        }
        
        .genre-filter-container::-webkit-scrollbar-thumb {
            background-color: var(--primary-color);
            border-radius: 10px;
        }
        
        .genre-filter-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
        }
        
        .genre-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 8px 16px;
            background: rgba(40, 40, 45, 0.8);
            color: var(--light-text);
            border: none;
            border-radius: 20px;
            margin-right: 6px;
            margin-bottom: 6px;
            font-size: 0.85rem;
            transition: all 0.25s ease;
            cursor: pointer;
            white-space: nowrap;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
        
        .genre-badge:hover {
            background: rgba(60, 60, 70, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            color: #fff;
        }
        
        .genre-badge.active {
            background: linear-gradient(90deg, var(--primary-color) 60%, var(--secondary-color) 100%);
            box-shadow: 0 4px 10px rgba(255, 64, 129, 0.3);
            transform: translateY(-2px);
            font-weight: 500;
            border: none;
        }
        
        .search-input-group {
            width: 300px;
            border-radius: 30px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            background: rgba(20, 20, 25, 0.8);
            transition: all 0.3s ease;
        }
        
        .search-input-group:focus-within {
            box-shadow: 0 0 0 3px rgba(255, 64, 129, 0.2);
            border-color: rgba(255, 64, 129, 0.4);
            background: rgba(30, 30, 35, 0.9);
        }
        
        .input-group-text {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 0;
        }
        
        #searchInput {
            background: transparent;
            border: none;
            color: var(--light-text);
            padding: 10px 15px;
            height: 42px;
            font-size: 0.95rem;
        }
        
        #searchInput:focus {
            box-shadow: none;
            outline: none;
        }
        
        @media (max-width: 768px) {
            .search-input-group {
                width: 100%;
                margin-top: 15px;
            }
            
            .filter-title {
                margin-bottom: 10px;
            }
            
            .d-flex.justify-content-between {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .d-flex.align-items-center {
                width: 100%;
            }
        }
        
        /* Favorites container */
        #favoritesContainer {
            background: rgba(20, 20, 25, 0.85);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            animation: fadeIn 0.4s ease-out;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 64, 129, 0.2);
        }
        
        .favorites-title {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 0;
            font-size: 1.6rem;
        }
        
        /* Movie poster styling */
        .movie-poster {
            height: 350px;
            object-fit: cover;
            object-position: center top;
            border-top-left-radius: var(--border-radius);
            border-top-right-radius: var(--border-radius);
            background-color: #232526;
            transition: transform 0.3s ease;
        }
        
        /* Movie card styling */
        .movie-card {
            margin-bottom: 20px;
        }
        
        .movie-card .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
            border: none;
            background-color: var(--card-bg);
            color: var(--light-text);
            cursor: pointer;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }
        
        .movie-card .card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 25px rgba(0, 0, 0, 0.4);
        }
        
        .movie-card .card:hover .movie-poster {
            transform: scale(1.03);
        }
        
        .movie-card .card-title {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 0.5rem;
            height: 2.5rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            font-size: 1.1rem;
        }
        
        .movie-card p {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: var(--medium-text);
        }
        
        .movie-card .card-body {
            padding: 15px;
        }
        
        .movie-card .overview {
            max-height: 80px;
            overflow: hidden;
            margin-bottom: 15px;
            color: var(--medium-text);
            font-size: 0.85rem;
        }
        
        /* Like button styling */
        .like-btn {
            background: linear-gradient(90deg, var(--primary-color) 60%, var(--secondary-color) 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 30px;
            margin-top: auto;
            align-self: start;
            font-weight: 600;
            transition: 0.3s;
            box-shadow: 0 2px 8px rgba(255, 64, 129, 0.3);
            font-size: 0.85rem;
        }
        
        .like-btn:hover {
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(255, 64, 129, 0.4);
        }
        
        .like-btn.btn-liked {
            background: #28a745;
            box-shadow: 0 2px 8px rgba(40, 167, 69, 0.3);
        }
        
        .like-btn.btn-liked:hover {
            background: #218838;
            box-shadow: 0 4px 12px rgba(40, 167, 69, 0.4);
        }
        
        /* Recommend button styling */
        .recommend-btn {
            background: linear-gradient(90deg, #3498db 60%, #2980b9 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 30px;
            font-weight: 600;
            transition: 0.3s;
            box-shadow: 0 2px 8px rgba(52, 152, 219, 0.3);
            font-size: 0.85rem;
        }
        
        .recommend-btn:hover {
            background: linear-gradient(90deg, #2980b9 0%, #3498db 100%);
            color: #fff;
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(52, 152, 219, 0.4);
        }
        
        /* Pagination styling */
        #pagination {
            margin: 2rem 0;
        }
        
        #pagination button {
            background: linear-gradient(90deg, var(--primary-color) 60%, var(--secondary-color) 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 30px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        #pagination button:hover:not(:disabled) {
            background: linear-gradient(90deg, var(--secondary-color) 0%, var(--primary-color) 100%);
            transform: translateY(-3px);
            box-shadow: 0 4px 12px rgba(255, 64, 129, 0.4);
        }
        
        #pagination button:disabled {
            background: #555;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        #pageInfo {
            background: rgba(30, 30, 30, 0.7);
            color: var(--light-text);
            padding: 10px 20px;
            border-radius: 30px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        /* Modal styling */
        .modal-content {
            background-color: var(--card-bg);
            color: var(--light-text);
            border: none;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            background: linear-gradient(90deg, var(--primary-color) 60%, var(--secondary-color) 100%);
            color: white;
            border-bottom: none;
            border-top-left-radius: 14px;
            border-top-right-radius: 14px;
            padding: 15px 20px;
        }
        
        .modal-title {
            font-weight: 600;
        }
        
        .btn-close {
            color: white;
            background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
        }
        
        /* Loading effect */
        .loading-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(18, 18, 18, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }
        
        .loading-container.active {
            opacity: 1;
            visibility: visible;
        }
        
        .loading-spinner {
            width: 60px;
            height: 60px;
            border: 5px solid rgba(255, 64, 129, 0.2);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Responsive adjustments */
        @media (max-width: 767px) {
            .header-area {
                padding: 10px 0;
            }
            
            .navbar-brand {
                font-size: 22px;
            }
            
            .user-welcome {
                font-size: 12px;
            }
            
            .btn-favorites, .btn-logout {
                padding: 8px 12px;
                font-size: 13px;
            }
            
            .movie-poster {
                height: 250px;
            }
            
            .search-filter-container {
                padding: 15px;
            }
            
            .genre-badge {
                padding: 8px 14px;
                font-size: 0.8rem;
            }
            
            .main-container {
                padding: 15px;
            }
            
            #pagination button {
                padding: 8px 15px;
                font-size: 14px;
            }
            
            #pageInfo {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
        
        /* Preexisting CSS that needs to be kept for functionality */
        /* CSS cho hiển thị phim trong popup gợi ý */
        .recommend-card .movie-poster {
            height: 120px;
            width: 80px;
            object-fit: cover;
        }

        /* Modal Chi Tiết Phim */
        #movieDetailModal .modal-dialog {
            max-width: 800px;
        }
        
        .movie-detail-poster {
            max-height: 400px;
            object-fit: cover;
            border-radius: 15px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        
        .movie-detail-info {
            padding: 20px;
        }
        
        .movie-detail-title {
            color: var(--primary-color);
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }
        
        .movie-detail-overview {
            margin-top: 20px;
            line-height: 1.6;
        }
        
        .movie-detail-meta {
            margin-bottom: 15px;
        }
        
        .movie-detail-meta span {
            display: inline-block;
            background-color: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-right: 8px;
            margin-bottom: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* Phần recommend */
        .recommend-card {
            background: rgba(40,42,54,0.97);
            border-radius: 12px;
            margin-bottom: 15px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
            transition: all 0.3s ease;
        }
        
        .recommend-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 64, 129, 0.2);
        }
        
        /* Favorite card */
        .favorite-card {
            margin-bottom: 15px;
        }
        
        .favorite-card .card {
            background: rgba(35, 37, 38, 0.9);
            border: none;
            border-radius: 15px;
            overflow: hidden;
            transition: all 0.3s ease;
        }
        
        .favorite-card .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 64, 129, 0.2);
        }
        
        .favorite-card .movie-poster {
            height: 200px;
            object-fit: cover;
        }
        
        .favorite-card .card-title {
            font-size: 1rem;
            height: auto;
            max-height: 2.4rem;
        }
        
        .favorite-card .remove-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(220, 53, 69, 0.8);
            color: white;
            border: none;
            border-radius: 50%;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s ease;
            z-index: 10;
        }
        
        .favorite-card .card:hover .remove-btn {
            opacity: 1;
        }
        
        .favorite-card .remove-btn:hover {
            background: #dc3545;
            transform: scale(1.1);
        }
    </style>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDGn25lfLVLX2eahI41LTLFx9whEZrgRIk",
            authDomain: "web-phim-6b76c.firebaseapp.com",
            databaseURL: "https://web-phim-6b76c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "web-phim-6b76c",
            storageBucket: "web-phim-6b76c.appspot.com",
            messagingSenderId: "676922439385",
            appId: "1:676922439385:web:476eea9d5265771ce230c8",
            measurementId: "G-B6Y0DSKFV2"
        };

        // Thêm div loading cho toàn trang
        document.body.insertAdjacentHTML('beforeend', `
            <div id="mainLoading" class="loading-container">
                <div class="loading-spinner"></div>
            </div>
        `);
        
        // Hiển thị loading khi bắt đầu
        function showLoading() {
            document.getElementById('mainLoading').classList.add('active');
        }
        
        function hideLoading() {
            document.getElementById('mainLoading').classList.remove('active');
        }
        
        // Hiển thị loading khi bắt đầu
        showLoading();

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let allMovies = [];

        // TMDB API Key
        const TMDB_API_KEY = "bd65461464529e3a5e518979a7a6065c";
        const TMDB_API_READ_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJiZDY1NDYxNDY0NTI5ZTNhNWU1MTg5NzlhN2E2MDY1YyIsIm5iZiI6MTc0NTY4MzM5MS4wMjgsInN1YiI6IjY4MGQwM2JmZDgwZmRmODJhN2VhYjM2YSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.sAUfjHZ4WzXvgfZCUaLS1kS0mjbMt5vQ14sZPT8r4sY";

        const S3_CSV_URL = "https://lxl-bucket.s3.ap-southeast-1.amazonaws.com/tmdb_5000_movies.csv";
        const API_RECOMMEND_URL = "https://qrvat15p0k.execute-api.ap-southeast-1.amazonaws.com/default/film-recommend-system";

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (!user) {
                window.location.href = "login.html";
            } else {
                document.getElementById('userInfo').style.display = '';
                document.getElementById('userEmail').innerText = user.email;
                
                // Kiểm tra số lượng phim đã thích để hiển thị badge
                updateFavoritesCount();
                
                // Khởi tạo trang
                initPage();
            }
        });

        // Hàm khởi tạo trang
        function initPage() {
            showLoading(); // Hiển thị loading khi bắt đầu tải dữ liệu
            
            // Thêm sự kiện tìm kiếm khi nhập
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterMovies();
                });
            }
            
            fetchCSVFromS3();
            
            // Thêm sự kiện khi scroll để tải poster 
            window.addEventListener('scroll', function() {
                // Kiểm tra các poster visible và tải nếu cần
                document.querySelectorAll('.movie-poster[data-id]').forEach(img => {
                    if (isElementInViewport(img) && img.src.includes('placehold.co')) {
                        const movieId = img.getAttribute('data-id');
                        if (movieId) {
                            if (posterCache[movieId] && posterCache[movieId] !== 'loading' && posterCache[movieId] !== 'error') {
                                img.src = posterCache[movieId];
                            } else if (posterCache[movieId] !== 'loading') {
                                loadPosterById(movieId);
                            }
                        }
                    }
                });
            });
            
            // Thêm sự kiện khi trang đã được tải hoàn toàn
            window.addEventListener('load', function() {
                setTimeout(hideLoading, 500); // Đảm bảo loading biến mất sau khi trang được tải
                
                // Cập nhật trạng thái nút thích khi trang đã tải xong
                setTimeout(updateAllLikeButtons, 1000);
            });
            
            // Ẩn loading nếu trang tải quá lâu (10 giây)
            setTimeout(hideLoading, 10000);
            
            // Tải danh sách phim đã thích khi khởi động
            loadFavoriteMovies();
        }

        // Kiểm tra phần tử có trong viewport không
        function isElementInViewport(el) {
            const rect = el.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        function logout() {
            auth.signOut();
            alert('Đã đăng xuất!');
            window.location.href = "login.html";
        }

        // Biến toàn cục cho phân trang
        let currentPage = 1;
        let moviesPerPage = 12;
        let filteredMovies = [];

        // Danh sách cache lưu URL poster đã tải
        let posterCache = {};
        
        // Khôi phục cache từ localStorage nếu có
        try {
            const savedCache = localStorage.getItem('posterCache');
            if (savedCache) {
                posterCache = JSON.parse(savedCache);
                console.log('Đã khôi phục cache poster:', Object.keys(posterCache).length);
            }
        } catch (e) {
            console.error('Lỗi khi khôi phục cache:', e);
            posterCache = {};
        }

        // Hàm lưu cache vào localStorage
        function savePosterCache() {
            try {
                localStorage.setItem('posterCache', JSON.stringify(posterCache));
            } catch (e) {
                console.error('Lỗi khi lưu cache:', e);
            }
        }

        function fetchCSVFromS3() {
            showLoading();
            
            fetch(S3_CSV_URL)
                .then(res => {
                    if (!res.ok) {
                        throw new Error(`Lỗi kết nối: ${res.status} ${res.statusText}`);
                    }
                    return res.text();
                })
                .then(csvText => {
                    if (!csvText || csvText.trim() === '') {
                        throw new Error('Không có dữ liệu CSV');
                    }
                    
                    const movies = parseCSV(csvText);
                    
                    if (!movies || movies.length === 0) {
                        throw new Error('Không thể đọc dữ liệu phim từ CSV');
                    }
                    
                    allMovies = movies;
                    filteredMovies = allMovies;
                    renderMovies(filteredMovies);
                    setupPagination();
                    hideLoading();
                })
                .catch(err => {
                    console.error('Lỗi tải dữ liệu CSV:', err);
                    hideLoading();
                    
                    document.getElementById('movieList').innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i> Lỗi tải dữ liệu: ${err.message}
                            </div>
                        </div>
                    `;
                });
        }
        
        // Hàm thử lại tải CSV
        function retryFetchCSV() {
            document.getElementById('movieList').innerHTML = '';
            fetchCSVFromS3();
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            const movies = [];
            
            try {
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length < headers.length) {
                        console.log(`Dòng ${i} có dữ liệu không đầy đủ, bỏ qua.`);
                        continue;
                    }
                    
                    const movie = {};
                    headers.forEach((header, index) => {
                        movie[header] = values[index] || '';
                    });
                    
                    // Đảm bảo id là số
                    if (movie.id) {
                        movie.id = parseInt(movie.id);
                    }
                    
                    try {
                        // Xử lý chuỗi JSON thể loại nếu có 
                        if (movie.genres && movie.genres.includes('{')) {
                            const genresRaw = movie.genres.replace(/""/g, '"');
                            const genres = JSON.parse(genresRaw);
                            movie.genres_str = Array.isArray(genres)
                                ? genres.map(g => g.name).join(', ')
                                : '';
                        } else {
                            movie.genres_str = movie.genres || '';
                        }
                    } catch (e) {
                        console.log(`Lỗi xử lý thể loại phim ${movie.title}:`, e);
                        movie.genres_str = movie.genres || '';
                    }
                    
                    // Đảm bảo luôn có tiêu đề
                    movie.title = movie.title || movie.original_title || `Phim #${i}`;
                    movies.push(movie);
                }
            } catch (e) {
                console.error("Lỗi xử lý CSV:", e);
            }
            
            // Log để debug
            if (movies.length > 0) {
                console.log("Dữ liệu phim đầu tiên:", movies[0]);
                console.log("Tổng số phim từ CSV:", movies.length);
            } else {
                console.error("Không có phim nào từ CSV");
            }
            
            return movies;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                if (char === '"' && inQuotes && nextChar === '"') {
                    current += '"';
                    i++;
                } else if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // Hàm tạo URL ảnh đại diện cho phim
        function getMoviePosterUrl(movie) {
            // Nếu có trong cache, sử dụng URL từ cache
            if (movie.id && posterCache[movie.id] && posterCache[movie.id] !== 'loading' && posterCache[movie.id] !== 'error') {
                return posterCache[movie.id];
            }
            
            // Nếu có poster_path hợp lệ, sử dụng TMDB (cấu trúc URL chính xác)
            if (movie.poster_path && movie.poster_path.length > 3) {
                // Đảm bảo poster_path bắt đầu bằng "/"
                const path = movie.poster_path.startsWith('/') ? movie.poster_path : '/' + movie.poster_path;
                const posterUrl = `https://image.tmdb.org/t/p/w500${path}`;
                
                // Lưu vào cache
                if (movie.id) {
                    posterCache[movie.id] = posterUrl;
                    savePosterCache();
                }
                
                return posterUrl;
            }
            
            // Nếu phim có ID, lưu vào cache và sẽ tải poster sau
            if (movie.id) {
                // Đánh dấu để tải poster sau
                setTimeout(() => {
                    loadPosterById(movie.id);
                }, 100);
            }
            
            // Trả về URL placeholder tạm thời
            const placeholderText = encodeURIComponent(movie.title || "Không có tên");
            return `https://placehold.co/300x450/232526/ff4081?text=${placeholderText}`;
        }

        // Hàm tải và cập nhật poster bằng ID phim
        async function loadPosterById(movieId) {
            // Nếu đã có trong cache và không phải đang tải, trả về URL trực tiếp
            if (posterCache[movieId] && posterCache[movieId] !== 'loading' && posterCache[movieId] !== 'error') {
                return posterCache[movieId];
            }

            // Nếu đang tải, bỏ qua
            if (posterCache[movieId] === 'loading') {
                return null;
            }

            // Đánh dấu trong cache để tránh tải lại nhiều lần
            posterCache[movieId] = 'loading';
            
            try {
                // Gọi API để lấy poster
                const posterUrl = await fetchMoviePoster(movieId);
                
                if (posterUrl) {
                    // Cập nhật vào cache
                    posterCache[movieId] = posterUrl;
                    savePosterCache(); // Lưu vào localStorage
                    
                    // Cập nhật tất cả poster có cùng ID
                    document.querySelectorAll(`.movie-poster[data-id="${movieId}"]`).forEach(img => {
                        // Chỉ cập nhật nếu là placeholder
                        if (img.src.includes('placehold.co')) {
                            img.src = posterUrl;
                        }
                    });

                    return posterUrl;
                }
            } catch (error) {
                console.error(`Lỗi tải poster cho phim ID ${movieId}:`, error);
                posterCache[movieId] = 'error';
                savePosterCache(); // Lưu cả lỗi vào cache
            }
            
            return null;
        }

        // Hàm để thử lấy ảnh từ OMDB API khi cần
        function tryFetchPosterFromOMDB(movieTitle, imgElement) {
            // Không cần nữa, đã sử dụng TMDB API
        }

        // Hàm truy vấn thông tin phim bằng TMDB API nếu bạn có API key
        function fetchTMDBPoster(movieId, imgElement) {
            // Không cần nữa, đã được thay thế bằng fetchMoviePoster
        }

        // Hàm để cố gắng lấy poster từ TMDB API
        function loadBackupPosters() {
            // Không cần nữa, đã được thay thế bằng loadPosterById
        }

        function renderMovies(movies) {
            try {
                const genreSet = new Set();
                movies.forEach(movie => {
                    if (movie.genres_str) {
                        movie.genres_str.split(',').forEach(g => genreSet.add(g.trim()));
                    }
                });

                const genreFilterButtons = document.getElementById('genreFilterButtons');
                const buttonContainer = document.createElement('div');
                buttonContainer.className = 'd-flex flex-wrap gap-2';
                
                // Thêm nút "Tất cả"
                const allButton = document.createElement('button');
                allButton.className = 'genre-badge active';
                allButton.textContent = 'Tất cả';
                allButton.dataset.genre = '';
                allButton.onclick = function() {
                    // Xóa active khỏi tất cả các nút
                    document.querySelectorAll('.genre-badge').forEach(btn => {
                        btn.classList.remove('active');
                    });
                    // Thêm active vào nút này
                    this.classList.add('active');
                    // Lọc phim
                    filterMovies();
                };
                buttonContainer.appendChild(allButton);
                
                // Thêm các nút thể loại
                Array.from(genreSet).sort().forEach(genre => {
                    // Bỏ qua các giá trị rỗng
                    if (!genre) return;
                    
                    const button = document.createElement('button');
                    button.className = 'genre-badge';
                    button.textContent = genre;
                    button.dataset.genre = genre;
                    button.onclick = function() {
                        // Xóa active khỏi tất cả các nút
                        document.querySelectorAll('.genre-badge').forEach(btn => {
                            btn.classList.remove('active');
                        });
                        // Thêm active vào nút này
                        this.classList.add('active');
                        // Lọc phim
                        filterMovies();
                    };
                    buttonContainer.appendChild(button);
                });
                
                genreFilterButtons.innerHTML = '';
                genreFilterButtons.appendChild(buttonContainer);

                // Hiển thị phim cho trang hiện tại
                displayCurrentPage();
            } catch (error) {
                console.error('Lỗi khi render giao diện:', error);
                document.getElementById('genreFilterButtons').innerHTML = `
                    <div class="alert alert-warning">
                        <i class="bi bi-exclamation-triangle-fill"></i> Lỗi tải bộ lọc: ${error.message}
                    </div>
                `;
                displayCurrentPage(); // Vẫn hiển thị phim nếu có
            }
        }

        function filterMovies() {
            const selectedGenreButton = document.querySelector('.genre-badge.active');
            const selectedGenre = selectedGenreButton ? selectedGenreButton.dataset.genre : '';
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            
            filteredMovies = allMovies.filter(movie => {
                // Kiểm tra khớp với thể loại đã chọn
                const matchGenre = !selectedGenre || 
                    movie.genres_str.split(',').map(g => g.trim()).includes(selectedGenre);
                
                // Kiểm tra khớp với từ khóa tìm kiếm
                const matchKeyword = !keyword || 
                    movie.title.toLowerCase().includes(keyword);
                
                return matchGenre && matchKeyword;
            });
            
            // Reset về trang 1 khi lọc
            currentPage = 1;
            displayCurrentPage();
            setupPagination();
        }

        function displayCurrentPage() {
            const startIndex = (currentPage - 1) * moviesPerPage;
            const endIndex = startIndex + moviesPerPage;
            const moviesToDisplay = filteredMovies.slice(startIndex, endIndex);
            
            renderMovieList(moviesToDisplay);
            
            // Cập nhật thông tin trang
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = Math.ceil(filteredMovies.length / moviesPerPage);
            
            // Cập nhật trạng thái nút phân trang
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= Math.ceil(filteredMovies.length / moviesPerPage);
            
            // Cập nhật trạng thái nút thích sau khi hiển thị danh sách phim
            setTimeout(updateAllLikeButtons, 300);
        }

        function setupPagination() {
            document.getElementById('prevPage').onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayCurrentPage();
                    window.scrollTo(0, 0);
                }
            };
            
            document.getElementById('nextPage').onclick = () => {
                const totalPages = Math.ceil(filteredMovies.length / moviesPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    displayCurrentPage();
                    window.scrollTo(0, 0);
                }
            };
            
            // Hiển thị tổng số trang
            document.getElementById('totalPages').textContent = Math.ceil(filteredMovies.length / moviesPerPage);
        }

        function renderMovieList(movies) {
            try {
                const container = document.getElementById('movieList');
                container.innerHTML = '';
                
                if (!movies || movies.length === 0) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-info">
                                <i class="bi bi-info-circle-fill"></i> Không tìm thấy phim nào phù hợp với tiêu chí tìm kiếm.
                            </div>
                        </div>
                    `;
                    return;
                }
                
                const movieIds = [];
                
                movies.forEach(movie => {
                    // Lấy URL poster
                    let posterUrl = getMoviePosterUrl(movie);
                    
                    // Thêm ID vào danh sách cần tải (nếu chưa có poster)
                    if (movie.id && (!posterCache[movie.id] || posterCache[movie.id] === 'error')) {
                        movieIds.push(movie.id);
                    }
                    
                    // Cắt ngắn mô tả phim
                    let overview = movie.overview || '';
                    const shortOverview = overview.length > 100 ? 
                        overview.substring(0, 100) + '...' : overview;
                    
                    const col = document.createElement('div');
                    col.className = 'col-md-6 col-lg-4 movie-card';
                    col.innerHTML = `
                        <div class="card shadow-sm h-100" data-movie-id="${movie.id || ''}">
                            <img src="${posterUrl}" class="card-img-top movie-poster" alt="${movie.title}" data-id="${movie.id || ''}" 
                                 onerror="this.onerror=null; if(this.src !== 'https://placehold.co/300x450/232526/ff4081?text=${encodeURIComponent(movie.title)}') this.src='https://placehold.co/300x450/232526/ff4081?text=${encodeURIComponent(movie.title)}'" 
                                 loading="lazy">
                            <div class="card-body d-flex flex-column">
                                <h5 class="card-title"><i class="bi bi-film"></i> ${movie.title}</h5>
                                <p><strong>Thể loại:</strong> ${movie.genres_str}</p>
                                <p><strong>Ngày phát hành:</strong> ${movie.release_date || 'Không rõ'}</p>
                                <p><strong>Điểm đánh giá:</strong> <span class="text-warning">${movie.vote_average || '?'}</span></p>
                                <p class="overview">${shortOverview || 'Không có mô tả'}</p>
                                <div class="mt-auto d-flex flex-wrap gap-2">
                                    <button class="like-btn" onclick="event.stopPropagation(); likeMovie('${movie.title.replace(/'/g, "\\'")}')">
                                        <i class="bi bi-heart-fill"></i> Thích
                                    </button>
                                    <button class="recommend-btn" onclick="event.stopPropagation(); getMovieRecommendations('${movie.title.replace(/'/g, "\\'")}')">
                                        <i class="bi bi-stars"></i> Đề xuất
                                    </button>
                                    <button class="btn btn-sm btn-outline-light" onclick="event.stopPropagation(); showMovieDetail('${movie.id}')">
                                        <i class="bi bi-info-circle"></i> Chi tiết
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                    container.appendChild(col);
                    
                    // Thêm sự kiện click vào thẻ phim
                    const card = col.querySelector('.card');
                    card.addEventListener('click', () => {
                        if (movie.id) {
                            showMovieDetail(movie.id);
                        }
                    });
                });
                
                // Tải hàng loạt poster nếu có nhiều ID
                if (movieIds.length > 0) {
                    setTimeout(() => {
                        movieIds.forEach(id => loadPosterById(id));
                    }, 500);
                }
            } catch (error) {
                console.error('Lỗi khi hiển thị danh sách phim:', error);
                document.getElementById('movieList').innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-danger">
                            <i class="bi bi-exclamation-triangle-fill"></i> Lỗi hiển thị phim: ${error.message}
                        </div>
                    </div>
                `;
            }
        }

        // Hàm kiểm tra và tải lại poster từ cache sau khi tải trang
        function reloadPostersFromCache() {
            document.querySelectorAll('.movie-poster[data-id]').forEach(img => {
                const movieId = img.getAttribute('data-id');
                if (movieId && img.src.includes('placehold.co')) {
                    if (posterCache[movieId] && posterCache[movieId] !== 'loading' && posterCache[movieId] !== 'error') {
                        img.src = posterCache[movieId];
                    }
                }
            });
        }
        
        // Đăng ký sự kiện reload
        window.addEventListener('load', reloadPostersFromCache);

        function likeMovie(title) {
            if (!currentUser) {
                alert('Bạn cần đăng nhập để thích phim!');
                return;
            }
            
            // Cập nhật trạng thái nút thích
            const likeButtons = document.querySelectorAll(`.like-btn[onclick*="${title.replace(/'/g, "\\'")}"]`);
            likeButtons.forEach(btn => {
                btn.innerHTML = `<i class="bi bi-hourglass-split"></i> Đang xử lý...`;
                btn.disabled = true;
            });
            
            // Đánh dấu nút trong modal nếu đang mở
            const detailLikeBtn = document.getElementById('likeMovieButton');
            if (detailLikeBtn && detailLikeBtn.getAttribute('onclick') && detailLikeBtn.getAttribute('onclick').includes(title.replace(/'/g, "\\'"))) {
                detailLikeBtn.innerHTML = `<i class="bi bi-hourglass-split me-2"></i> Đang xử lý...`;
                detailLikeBtn.disabled = true;
            }
            
            // Kiểm tra xem phim đã được thích chưa
            const userId = currentUser.uid;
            const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
            
            userMoviesRef.once('value').then(snapshot => {
                let liked = snapshot.val() || [];
                const isAlreadyLiked = liked.includes(title);
                
                if (isAlreadyLiked) {
                    // Nếu đã thích rồi thì bỏ thích
                    liked = liked.filter(movieTitle => movieTitle !== title);
                } else {
                    // Nếu chưa thích thì thêm vào danh sách thích
                    liked.push(title);
                }
                
                // Cập nhật danh sách phim đã thích
                return userMoviesRef.set(liked).then(() => {
                    // Cập nhật trạng thái nút thích
                    updateLikeButtonsForMovie(title, !isAlreadyLiked);
                    
                    // Cập nhật trạng thái của tất cả nút thích
                    updateAllLikeButtons();
                    
                    // Cập nhật danh sách phim đã thích nếu đang hiển thị
                    if (document.getElementById('favoritesContainer').style.display !== 'none') {
                        loadFavoriteMovies();
                    } else {
                        // Cập nhật số lượng phim đã thích trên badge
                        updateFavoritesCount();
                    }
                    
                    // Thông báo
                    if (!isAlreadyLiked) {
                        alert("Đã thêm phim vào danh sách yêu thích!");
                    } else {
                        alert("Đã xóa phim khỏi danh sách yêu thích!");
                    }
                });
            }).catch(err => {
                console.error("Lỗi khi thích/bỏ thích phim:", err);
                
                // Khôi phục trạng thái nút
                updateLikeButtonsForMovie(title, false);
                
                alert(`Không thể thích/bỏ thích phim: ${err.message}`);
            });
        }

        function showRecommendPopup(recommendTitles) {
            try {
                const content = document.getElementById('recommendContent');
                
                if (!recommendTitles || recommendTitles.length === 0) {
                    content.innerHTML = `<div class="alert alert-warning">Không có phim gợi ý.</div>`;
                } else {
                    // Lấy thông tin chi tiết phim từ allMovies (nếu có)
                    const recommendMovies = recommendTitles.map(title =>
                        allMovies.find(m => m.title === title)
                        || { title, genres_str: '', release_date: '', vote_average: '', overview: '', poster_path: '', id: '' }
                    );

                    // Lấy danh sách phim đã thích để hiển thị trạng thái đúng
                    if (currentUser) {
                        const userId = currentUser.uid;
                        const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
                        
                        userMoviesRef.once('value')
                            .then(snapshot => {
                                const likedMovies = snapshot.val() || [];
                                
                                content.innerHTML = `
                                    <div class="recommend-list">
                                        ${recommendMovies.map(movie => {
                                            // Lấy URL poster
                                            let posterUrl = getMoviePosterUrl(movie);
                                            
                                            // Cắt ngắn mô tả phim
                                            let overview = movie.overview || '';
                                            const shortOverview = overview.length > 100 ? 
                                                overview.substring(0, 100) + '...' : overview;
                                            
                                            // Kiểm tra nếu phim đã được thích
                                            const isLiked = likedMovies.includes(movie.title);
                                            
                                            // Hiển thị nút thích với trạng thái phù hợp
                                            let likeButton = '';
                                            if (isLiked) {
                                                likeButton = `
                                                    <button class="btn btn-success" disabled>
                                                        <i class="bi bi-heart-fill"></i> Đã thích
                                                    </button>
                                                `;
                                            } else {
                                                likeButton = `
                                                    <button class="btn btn-outline-primary" onclick="likeMovieFromRecommend('${movie.title.replace(/'/g, "\\'")}')">
                                                        <i class="bi bi-heart"></i> Thêm vào danh sách yêu thích
                                                    </button>
                                                `;
                                            }
                                            
                                            return `
                                                <div class="card recommend-card mb-3 shadow border-0">
                                                <div class="card-body d-flex flex-column flex-md-row align-items-md-center">
                                                    <img src="${posterUrl}" class="movie-poster me-3" alt="${movie.title}" data-id="${movie.id || ''}"
                                                        onerror="this.onerror=null; this.src='https://placehold.co/300x450/232526/ff4081?text=${encodeURIComponent(movie.title)}'"
                                                        loading="lazy">
                                                    <div class="flex-fill">
                                                    <h6 class="card-title mb-2 text-pink"><i class="bi bi-film"></i> ${movie.title}</h6>
                                                    <p class="mb-1"><strong>Thể loại:</strong> ${movie.genres_str || '<span class="text-muted">Không rõ</span>'}</p>
                                                    <p class="mb-1"><strong>Ngày phát hành:</strong> ${movie.release_date || '<span class="text-muted">Không rõ</span>'}</p>
                                                    <p class="mb-1"><strong>Điểm đánh giá:</strong> <span class="text-warning">${movie.vote_average || '?'}</span></p>
                                                    <p class="mb-2 overview">${shortOverview || '<span class="text-muted">Không có mô tả</span>'}</p>
                                                    </div>
                                                    <div class="ms-md-3 mt-3 mt-md-0">
                                                    ${likeButton}
                                                    ${movie.id ? `<button class="btn btn-sm btn-outline-light mt-2 w-100" onclick="showMovieDetail('${movie.id}')">
                                                        <i class="bi bi-info-circle"></i> Chi tiết
                                                    </button>` : ''}
                                                    </div>
                                                </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                `;
                                
                                // Hiện modal sau khi đã render nội dung
                                const modal = new bootstrap.Modal(document.getElementById('recommendModal'));
                                modal.show();
                            })
                            .catch(error => {
                                console.error("Lỗi khi tải trạng thái phim đã thích:", error);
                                // Hiển thị mà không kiểm tra trạng thái đã thích
                                renderRecommendContentWithoutLikeStatus();
                            });
                    } else {
                        // Người dùng chưa đăng nhập, hiển thị mà không kiểm tra trạng thái đã thích
                        renderRecommendContentWithoutLikeStatus();
                    }
                    
                    // Hàm để render nội dung mà không kiểm tra trạng thái đã thích
                    function renderRecommendContentWithoutLikeStatus() {
                        content.innerHTML = `
                            <div class="recommend-list">
                                ${recommendMovies.map(movie => {
                                    // Lấy URL poster
                                    let posterUrl = getMoviePosterUrl(movie);
                                    
                                    // Cắt ngắn mô tả phim
                                    let overview = movie.overview || '';
                                    const shortOverview = overview.length > 100 ? 
                                        overview.substring(0, 100) + '...' : overview;
                                    
                                    return `
                                        <div class="card recommend-card mb-3 shadow border-0">
                                        <div class="card-body d-flex flex-column flex-md-row align-items-md-center">
                                            <img src="${posterUrl}" class="movie-poster me-3" alt="${movie.title}" data-id="${movie.id || ''}"
                                                onerror="this.onerror=null; this.src='https://placehold.co/300x450/232526/ff4081?text=${encodeURIComponent(movie.title)}'"
                                                loading="lazy">
                                            <div class="flex-fill">
                                            <h6 class="card-title mb-2 text-pink"><i class="bi bi-film"></i> ${movie.title}</h6>
                                            <p class="mb-1"><strong>Thể loại:</strong> ${movie.genres_str || '<span class="text-muted">Không rõ</span>'}</p>
                                            <p class="mb-1"><strong>Ngày phát hành:</strong> ${movie.release_date || '<span class="text-muted">Không rõ</span>'}</p>
                                            <p class="mb-1"><strong>Điểm đánh giá:</strong> <span class="text-warning">${movie.vote_average || '?'}</span></p>
                                            <p class="mb-2 overview">${shortOverview || '<span class="text-muted">Không có mô tả</span>'}</p>
                                            </div>
                                            <div class="ms-md-3 mt-3 mt-md-0">
                                            <button class="btn btn-outline-primary" onclick="likeMovieFromRecommend('${movie.title.replace(/'/g, "\\'")}')">
                                                <i class="bi bi-heart"></i> Thêm vào danh sách yêu thích
                                            </button>
                                            ${movie.id ? `<button class="btn btn-sm btn-outline-light mt-2 w-100" onclick="showMovieDetail('${movie.id}')">
                                                <i class="bi bi-info-circle"></i> Chi tiết
                                            </button>` : ''}
                                            </div>
                                        </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        `;
                        
                        // Hiện modal sau khi đã render nội dung
                        const modal = new bootstrap.Modal(document.getElementById('recommendModal'));
                        modal.show();
                    }
                }
            } catch (error) {
                console.error("Lỗi hiển thị popup gợi ý:", error);
                alert("Không thể hiển thị phim gợi ý do lỗi kỹ thuật.");
            }
        }

        // Hàm này để thêm phim vào danh sách yêu thích từ popup (nếu muốn)
        function likeMovieFromRecommend(title) {
            if (!currentUser) {
                alert('Bạn cần đăng nhập để thích phim!');
                return;
            }
            
            const likeButton = event.target.closest('button');
            if (likeButton) {
                likeButton.innerHTML = `<i class="bi bi-hourglass-split"></i> Đang xử lý...`;
                likeButton.disabled = true;
            }
            
            const userId = currentUser.uid;
            const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
            userMoviesRef.once('value').then(snapshot => {
                let liked = snapshot.val() || [];
                if (!liked.includes(title)) {
                    liked.push(title);
                    return userMoviesRef.set(liked);
                }
                return Promise.resolve();
            })
            .then(() => {
                if (likeButton) {
                    likeButton.innerHTML = `<i class="bi bi-heart-fill"></i> Đã thích`;
                    likeButton.classList.add('btn-success');
                    likeButton.disabled = true;
                }
                
                // Cập nhật trạng thái nút thích cho phim này
                updateLikeButtonsForMovie(title, true);
                
                // Cập nhật danh sách phim đã thích nếu đang hiển thị
                if (document.getElementById('favoritesContainer').style.display !== 'none') {
                    loadFavoriteMovies();
                } else {
                    // Cập nhật số lượng phim đã thích trên badge
                    updateFavoritesCount();
                }
                
                alert("Đã thêm vào danh sách yêu thích!");
            })
            .catch(error => {
                console.error("Lỗi khi thích phim:", error);
                if (likeButton) {
                    likeButton.innerHTML = `<i class="bi bi-heart"></i> Thêm vào danh sách yêu thích`;
                    likeButton.disabled = false;
                }
                alert(`Không thể thích phim: ${error.message}`);
            });
        }

        // Đảm bảo ID là số khi so sánh
        function parseMovieId(id) {
            try {
                return parseInt(id);
            } catch {
                return 0;
            }
        }

        // Hàm để lấy poster phim từ API TMDB
        async function fetchMoviePoster(movieId) {
            try {
                const response = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${TMDB_API_KEY}&language=en-US`);
                const data = await response.json();
                
                if (data.poster_path) {
                    return `https://image.tmdb.org/t/p/w500${data.poster_path}`;
                }
                return null;
            } catch (error) {
                console.error(`Lỗi khi lấy thông tin phim ${movieId}:`, error);
                return null;
            }
        }

        // Thêm sự kiện để tải lại poster khi trở lại trang
        window.addEventListener('pageshow', function(event) {
            // Tải lại poster khi quay lại trang (sử dụng cache nếu có)
            if (event.persisted) {
                console.log('Trang được khôi phục từ cache trình duyệt, tải lại poster');
                setTimeout(() => {
                    document.querySelectorAll('.movie-poster[data-id]').forEach(img => {
                        const movieId = img.getAttribute('data-id');
                        if (movieId && img.src.includes('placehold.co')) {
                            if (posterCache[movieId] && posterCache[movieId] !== 'loading' && posterCache[movieId] !== 'error') {
                                img.src = posterCache[movieId];
                            } else {
                                loadPosterById(movieId);
                            }
                        }
                    });
                }, 300);
            }
        });

        // Thêm sự kiện tìm kiếm khi nhập
        document.addEventListener('DOMContentLoaded', function() {
            const searchInput = document.getElementById('searchInput');
            if (searchInput) {
                searchInput.addEventListener('input', function() {
                    filterMovies();
                });
            }
        });

        // Sửa hàm hiển thị chi tiết phim trong modal
        async function showMovieDetail(movieId) {
            try {
                // Chuyển đổi movieId thành số 
                movieId = parseInt(movieId);
                
                // Lấy đối tượng modal
                const modal = new bootstrap.Modal(document.getElementById('movieDetailModal'));
                const contentEl = document.getElementById('movieDetailContent');
                
                // Hiển thị loading
                contentEl.innerHTML = `
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                        <p>Đang tải thông tin phim...</p>
                    </div>
                `;
                
                // Hiện modal trước khi tải dữ liệu
                modal.show();
                
                // Tìm phim từ ID
                const movie = allMovies.find(m => m.id === movieId);
                
                if (!movie) {
                    contentEl.innerHTML = `<div class="alert alert-warning">Không tìm thấy thông tin phim!</div>`;
                    return;
                }
                
                // Tải thông tin chi tiết từ API TMDB
                let detailData = null;
                try {
                    const response = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${TMDB_API_KEY}&language=en-US`);
                    if (response.ok) {
                        detailData = await response.json();
                    }
                } catch (e) {
                    console.error("Lỗi tải thông tin chi tiết phim:", e);
                }
                
                // Lấy URL poster
                let posterUrl = getMoviePosterUrl(movie);
                
                // Nếu có data từ API thì ưu tiên sử dụng
                if (detailData) {
                    // Tạo chuỗi thể loại
                    const genres = detailData.genres && detailData.genres.length 
                        ? detailData.genres.map(g => g.name).join(', ') 
                        : movie.genres_str;
                    
                    // Sử dụng overview và thông tin khác từ API
                    const overview = detailData.overview || movie.overview || 'Không có mô tả';
                    const releaseDate = detailData.release_date || movie.release_date || 'Không rõ';
                    const voteAverage = detailData.vote_average || movie.vote_average || '?';
                    const runtime = detailData.runtime ? `${detailData.runtime} phút` : 'Không rõ';
                    
                    // Nếu có poster path từ API
                    if (detailData.poster_path) {
                        posterUrl = `https://image.tmdb.org/t/p/w500${detailData.poster_path}`;
                        
                        // Lưu vào cache
                        if (movie.id) {
                            posterCache[movie.id] = posterUrl;
                            savePosterCache();
                        }
                    }
                    
                    // Hiển thị chi tiết với dữ liệu từ API
                    renderDetailContent(contentEl, {
                        id: movie.id,
                        title: detailData.title || movie.title,
                        originalTitle: detailData.original_title,
                        posterUrl,
                        overview,
                        genres,
                        releaseDate,
                        voteAverage,
                        runtime,
                        budget: detailData.budget ? formatMoney(detailData.budget) : 'Không rõ',
                        revenue: detailData.revenue ? formatMoney(detailData.revenue) : 'Không rõ',
                        productionCompanies: detailData.production_companies || []
                    });
                } else {
                    // Sử dụng dữ liệu từ tập dữ liệu gốc
                    renderDetailContent(contentEl, {
                        id: movie.id,
                        title: movie.title,
                        originalTitle: movie.original_title,
                        posterUrl,
                        overview: movie.overview || 'Không có mô tả',
                        genres: movie.genres_str || 'Không rõ',
                        releaseDate: movie.release_date || 'Không rõ',
                        voteAverage: movie.vote_average || '?',
                        runtime: 'Không rõ',
                        budget: movie.budget ? formatMoney(movie.budget) : 'Không rõ',
                        revenue: 'Không rõ',
                        productionCompanies: []
                    });
                }
                
                // Cập nhật trạng thái tất cả nút thích ngay sau khi hiển thị nội dung
                setTimeout(updateAllLikeButtons, 100);
            } catch (error) {
                console.error("Lỗi hiển thị chi tiết phim:", error);
                document.getElementById('movieDetailContent').innerHTML = `
                    <div class="alert alert-danger">
                        Đã xảy ra lỗi khi tải thông tin phim. Vui lòng thử lại sau.
                    </div>
                `;
            }
        }

        // Hàm hiển thị nội dung chi tiết phim
        function renderDetailContent(container, movie) {
            // Chuẩn bị danh sách hãng sản xuất
            let productionCompaniesHTML = '';
            if (movie.productionCompanies && movie.productionCompanies.length > 0) {
                productionCompaniesHTML = `
                    <div class="mt-4">
                        <h6 class="mb-2"><i class="bi bi-building"></i> Hãng sản xuất:</h6>
                        <div class="d-flex flex-wrap">
                            ${movie.productionCompanies.map(c => 
                                `<span class="badge bg-secondary me-2 mb-2 p-2">${c.name}</span>`
                            ).join('')}
                        </div>
                    </div>
                `;
            }
            
            // Hiển thị nội dung
            container.innerHTML = `
                <div class="row">
                    <div class="col-md-4 text-center mb-3">
                        <img src="${movie.posterUrl}" alt="${movie.title}" class="movie-detail-poster img-fluid shadow"
                            onerror="this.onerror=null; this.src='https://placehold.co/300x450/232526/ff4081?text=${encodeURIComponent(movie.title)}'">
                    </div>
                    <div class="col-md-8">
                        <div class="movie-detail-info">
                            <h3 class="movie-detail-title">${movie.title}</h3>
                            ${movie.originalTitle && movie.originalTitle !== movie.title ? 
                                `<h6 class="text-muted mb-3">${movie.originalTitle}</h6>` : ''}
                            
                            <div class="movie-detail-meta">
                                <span><i class="bi bi-calendar3"></i> ${movie.releaseDate}</span>
                                ${movie.runtime !== 'Không rõ' ? `<span><i class="bi bi-clock"></i> ${movie.runtime}</span>` : ''}
                                <span><i class="bi bi-star-fill"></i> ${movie.voteAverage}</span>
                            </div>
                            
                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <p class="mb-2"><i class="bi bi-tags"></i> <strong>Thể loại:</strong></p>
                                    <div class="d-flex flex-wrap">
                                        ${movie.genres.split(',').map(genre => 
                                            `<span class="badge bg-primary me-2 mb-2 p-2">${genre.trim()}</span>`
                                        ).join('')}
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <p class="mb-1"><i class="bi bi-cash-coin"></i> <strong>Ngân sách:</strong> ${movie.budget}</p>
                                    <p class="mb-3"><i class="bi bi-graph-up-arrow"></i> <strong>Doanh thu:</strong> ${movie.revenue}</p>
                                </div>
                            </div>
                            
                            <div class="movie-detail-overview mt-4">
                                <h6 class="mb-2"><i class="bi bi-text-paragraph"></i> Nội dung:</h6>
                                <p>${movie.overview}</p>
                            </div>
                            
                            ${productionCompaniesHTML}
                        </div>
                    </div>
                </div>
                <div class="row mt-4">
                    <div class="col-12 text-center">
                        <div class="d-flex justify-content-center gap-3">
                            <button id="likeMovieButton" class="btn btn-primary px-4 py-2" onclick="likeMovie('${movie.title.replace(/'/g, "\\'")}')">
                                <i class="bi bi-heart-fill me-2"></i> Thích phim này
                            </button>
                            <button class="btn btn-info px-4 py-2" onclick="getMovieRecommendations('${movie.title.replace(/'/g, "\\'")}')">
                                <i class="bi bi-stars me-2"></i> Đề xuất phim tương tự
                            </button>
                        </div>
                    </div>
                </div>
            `;
        }

        // Hàm định dạng tiền tệ
        function formatMoney(amount) {
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'USD',
                maximumFractionDigits: 0
            }).format(amount);
        }

        // Hiển thị modal chi tiết phim từ phim gợi ý
        function showMovieDetailFromRecommend(movieId, title) {
            // Đóng modal recommend trước
            const recommendModal = bootstrap.Modal.getInstance(document.getElementById('recommendModal'));
            if (recommendModal) {
                recommendModal.hide();
                
                // Chờ một chút để modal recommend đóng hoàn toàn
                setTimeout(() => {
                    showMovieDetail(movieId);
                    // Cập nhật trạng thái nút thích sau khi mở chi tiết phim
                    setTimeout(updateAllLikeButtons, 500);
                }, 500);
            } else {
                showMovieDetail(movieId);
                // Cập nhật trạng thái nút thích sau khi mở chi tiết phim
                setTimeout(updateAllLikeButtons, 500);
            }
        }

        function formatNumber(number) {
            return new Intl.NumberFormat('vi-VN').format(number);
        }

        // Khởi tạo thông báo lỗi chung
        window.addEventListener('error', function(event) {
            console.error('Lỗi JS:', event.error);
            
            // Ẩn loading nếu có lỗi
            hideLoading();
            
            // Hiển thị thông báo lỗi nếu trang chưa tải được phim
            if (allMovies.length === 0) {
                const container = document.getElementById('movieList');
                if (container) {
                    container.innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i> Đã xảy ra lỗi khi tải trang. Vui lòng tải lại trang.
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="location.reload()">
                                        <i class="bi bi-arrow-repeat"></i> Tải lại trang
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
        });
        
        // Hiện thành công khi trang đã tải xong
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                if (allMovies.length > 0) {
                    hideLoading();
                }
            }, 3000);
        });

        // Cập nhật số lượng phim đã thích
        function updateFavoritesCount() {
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
            
            userMoviesRef.once('value')
                .then(snapshot => {
                    const likedMovies = snapshot.val() || [];
                    const count = likedMovies.length;
                    
                    // Cập nhật nút hiển thị phim đã thích
                    const favBtn = document.getElementById('favoritesBtn');
                    
                    if (count > 0) {
                        favBtn.innerHTML = `<i class="bi bi-heart-fill"></i> Phim đã thích <span class="badge bg-light text-dark">${count}</span>`;
                    } else {
                        favBtn.innerHTML = `<i class="bi bi-heart"></i> Phim đã thích`;
                    }
                })
                .catch(error => {
                    console.error("Lỗi khi đếm phim đã thích:", error);
                });
        }
        
        // Kiểm tra phim đã được thích chưa
        function checkIfMovieLiked(title) {
            if (!currentUser) return false;
            
            const userId = currentUser.uid;
            const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
            
            return userMoviesRef.once('value')
                .then(snapshot => {
                    const likedMovies = snapshot.val() || [];
                    return likedMovies.includes(title);
                })
                .catch(error => {
                    console.error("Lỗi khi kiểm tra trạng thái thích:", error);
                    return false;
                });
        }

        // Hiển thị phần phim đã thích
        function showFavorites() {
            document.getElementById('favoritesContainer').style.display = 'block';
            document.getElementById('favoritesBtn').disabled = true;
            
            // Tải danh sách phim đã thích
            loadFavoriteMovies();
            
            // Cuộn đến phần phim đã thích
            document.getElementById('favoritesContainer').scrollIntoView({ behavior: 'smooth' });
        }

        // Ẩn phần phim đã thích
        function hideFavorites() {
            document.getElementById('favoritesContainer').style.display = 'none';
            document.getElementById('favoritesBtn').disabled = false;
        }

        // Tải danh sách phim đã thích từ Firebase
        function loadFavoriteMovies() {
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
            
            // Hiển thị trạng thái đang tải
            document.getElementById('favoritesList').innerHTML = `
                <div class="col-12 text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Đang tải...</span>
                    </div>
                    <p class="mt-2">Đang tải danh sách phim đã thích...</p>
                </div>
            `;
            
            userMoviesRef.once('value')
                .then(snapshot => {
                    const likedMovies = snapshot.val() || [];
                    
                    // Cập nhật số lượng phim đã thích
                    updateFavoritesCount();
                    
                    if (likedMovies.length === 0) {
                        document.getElementById('favoritesList').innerHTML = `
                            <div class="col-12">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle-fill"></i> Bạn chưa thích phim nào. Hãy khám phá danh sách phim và thêm vào danh sách yêu thích!
                                </div>
                            </div>
                        `;
                        return;
                    }
                    
                    renderFavoriteMovies(likedMovies);
                })
                .catch(error => {
                    console.error("Lỗi khi tải danh sách phim đã thích:", error);
                    document.getElementById('favoritesList').innerHTML = `
                        <div class="col-12">
                            <div class="alert alert-danger">
                                <i class="bi bi-exclamation-triangle-fill"></i> Lỗi khi tải danh sách phim đã thích: ${error.message}
                                <div class="mt-3">
                                    <button class="btn btn-primary" onclick="loadFavoriteMovies()">
                                        <i class="bi bi-arrow-repeat"></i> Thử lại
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                });
        }

        // Hiển thị danh sách phim đã thích
        function renderFavoriteMovies(likedMovieTitles) {
            const favoritesList = document.getElementById('favoritesList');
            favoritesList.innerHTML = '';
            
            // Tìm thông tin chi tiết của các phim đã thích từ allMovies
            const favoriteMovies = likedMovieTitles.map(title => 
                allMovies.find(movie => movie.title === title)
            ).filter(movie => movie !== undefined);
            
            if (favoriteMovies.length === 0) {
                favoritesList.innerHTML = `
                    <div class="col-12">
                        <div class="alert alert-warning">
                            <i class="bi bi-exclamation-triangle-fill"></i> Không tìm thấy thông tin chi tiết của phim đã thích. Danh sách phim có thể đã thay đổi.
                        </div>
                    </div>
                `;
                return;
            }
            
            // Hiển thị số lượng phim đã thích
            const notFoundCount = likedMovieTitles.length - favoriteMovies.length;
            if (notFoundCount > 0) {
                const infoDiv = document.createElement('div');
                infoDiv.className = 'col-12 mb-3';
                infoDiv.innerHTML = `
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill"></i> Đang hiển thị ${favoriteMovies.length} phim. ${notFoundCount} phim khác không tìm thấy trong dữ liệu hiện tại.
                    </div>
                `;
                favoritesList.appendChild(infoDiv);
            }
            
            // Hiển thị danh sách phim đã thích
            favoriteMovies.forEach(movie => {
                const posterUrl = getMoviePosterUrl(movie);
                
                const col = document.createElement('div');
                col.className = 'col-6 col-md-4 col-lg-3 favorite-card';
                col.innerHTML = `
                    <div class="card h-100" data-title="${movie.title.replace(/'/g, "\\'")}">
                        <button class="remove-btn" onclick="removeFromFavorites('${movie.title.replace(/'/g, "\\'")}')">
                            <i class="bi bi-x"></i>
                        </button>
                        <img src="${posterUrl}" class="card-img-top movie-poster" alt="${movie.title}" data-id="${movie.id || ''}" 
                             onerror="this.onerror=null; this.src='https://placehold.co/300x450/232526/ff4081?text=${encodeURIComponent(movie.title)}'" 
                             loading="lazy">
                        <div class="card-body">
                            <h5 class="card-title">${movie.title}</h5>
                            <p class="mb-1"><small><i class="bi bi-tag-fill"></i> ${movie.genres_str || 'Không rõ thể loại'}</small></p>
                            <p class="mb-2"><small><i class="bi bi-star-fill text-warning"></i> ${movie.vote_average || '?'}</small></p>
                            <div class="d-flex flex-column gap-2 mt-2">
                                <button class="btn btn-sm btn-primary w-100" onclick="getMovieRecommendations('${movie.title.replace(/'/g, "\\'")}')">
                                    <i class="bi bi-stars"></i> Đề xuất
                                </button>
                                <button class="btn btn-sm btn-outline-light w-100" onclick="showMovieDetail('${movie.id}')">
                                    <i class="bi bi-info-circle"></i> Chi tiết
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                favoritesList.appendChild(col);
            });
        }

        // Xóa phim khỏi danh sách yêu thích
        function removeFromFavorites(title) {
            if (!currentUser) return;
            
            const confirmed = confirm(`Bạn có chắc muốn xóa "${title}" khỏi danh sách phim đã thích?`);
            if (!confirmed) return;
            
            const userId = currentUser.uid;
            const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
            
            // Hiển thị trạng thái loading trên thẻ phim
            const favoriteCard = document.querySelector(`.favorite-card .card[data-title="${title.replace(/'/g, "\\'")}"]`);
            if (favoriteCard) {
                favoriteCard.classList.add('removing');
                favoriteCard.innerHTML = `
                    <div class="text-center py-4">
                        <div class="spinner-border text-danger" role="status">
                            <span class="visually-hidden">Đang xóa...</span>
                        </div>
                        <p class="mt-2">Đang xóa...</p>
                    </div>
                `;
            }
            
            userMoviesRef.once('value')
                .then(snapshot => {
                    let likedMovies = snapshot.val() || [];
                    likedMovies = likedMovies.filter(movieTitle => movieTitle !== title);
                    
                    return userMoviesRef.set(likedMovies);
                })
                .then(() => {
                    // Cập nhật lại giao diện
                    loadFavoriteMovies();
                    
                    // Cập nhật trạng thái các nút like cho phim này
                    updateLikeButtonsForMovie(title, false);
                    
                    // Thông báo không hiện alert để trải nghiệm tốt hơn
                })
                .catch(error => {
                    console.error("Lỗi khi xóa phim khỏi danh sách yêu thích:", error);
                    alert(`Lỗi khi xóa phim: ${error.message}`);
                    loadFavoriteMovies(); // Tải lại danh sách nếu có lỗi
                });
        }
        
        // Cập nhật trạng thái nút "thích" cho phim
        function updateLikeButtonsForMovie(title, isLiked) {
            try {
                console.log(`Đang cập nhật nút thích cho phim "${title}" với trạng thái: ${isLiked ? 'đã thích' : 'chưa thích'}`);
                
                // Tìm tất cả nút "thích" cho phim này trong danh sách phim chính
                const likeButtons = document.querySelectorAll(`.like-btn[onclick*="${title.replace(/'/g, "\\'")}"]`);
                
                likeButtons.forEach(btn => {
                    if (isLiked) {
                        btn.innerHTML = `<i class="bi bi-heart-fill"></i> Đã thích`;
                        btn.classList.add('btn-liked');
                    } else {
                        btn.innerHTML = `<i class="bi bi-heart"></i> Thích`;
                        btn.classList.remove('btn-liked');
                    }
                    btn.disabled = false;
                });
                
                // Cập nhật nút trong modal chi tiết phim nếu đang mở
                const detailLikeBtn = document.getElementById('likeMovieButton');
                if (detailLikeBtn && detailLikeBtn.getAttribute('onclick') && detailLikeBtn.getAttribute('onclick').includes(title.replace(/'/g, "\\'"))) {
                    if (isLiked) {
                        detailLikeBtn.innerHTML = `<i class="bi bi-heart-fill me-2"></i> Đã thích`;
                        detailLikeBtn.classList.add('btn-liked');
                    } else {
                        detailLikeBtn.innerHTML = `<i class="bi bi-heart-fill me-2"></i> Thích phim này`;
                        detailLikeBtn.classList.remove('btn-liked');
                    }
                    detailLikeBtn.disabled = false;
                }
                
                console.log(`Đã cập nhật ${likeButtons.length} nút thích cho phim "${title}"`);
            } catch (error) {
                console.error(`Lỗi khi cập nhật nút thích cho phim "${title}":`, error);
            }
        }

        // Kiểm tra và cập nhật trạng thái thích cho tất cả phim khi trang tải xong
        function updateAllLikeButtons() {
            if (!currentUser) return;
            
            const userId = currentUser.uid;
            const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
            
            userMoviesRef.once('value')
                .then(snapshot => {
                    const likedMovies = snapshot.val() || [];
                    
                    // Cập nhật trạng thái của tất cả nút "thích"
                    document.querySelectorAll('.like-btn').forEach(btn => {
                        const onclickAttr = btn.getAttribute('onclick') || '';
                        // Tìm tên phim từ thuộc tính onclick
                        const titleMatch = onclickAttr.match(/likeMovie\(['"](.+?)['"]\)/);
                        if (titleMatch && titleMatch[1]) {
                            const movieTitle = titleMatch[1].replace(/\\'/g, "'");
                            const isLiked = likedMovies.includes(movieTitle);
                            
                            if (isLiked) {
                                btn.innerHTML = `<i class="bi bi-heart-fill"></i> Đã thích`;
                                btn.classList.add('btn-liked');
                            } else {
                                btn.innerHTML = `<i class="bi bi-heart"></i> Thích`;
                                btn.classList.remove('btn-liked');
                            }
                        }
                    });
                    
                    // Cập nhật nút thích trong modal chi tiết phim nếu đang mở
                    const detailLikeBtn = document.getElementById('likeMovieButton');
                    if (detailLikeBtn && detailLikeBtn.getAttribute('onclick')) {
                        const onclickAttr = detailLikeBtn.getAttribute('onclick');
                        const titleMatch = onclickAttr.match(/likeMovie\(['"](.+?)['"]\)/);
                        if (titleMatch && titleMatch[1]) {
                            const movieTitle = titleMatch[1].replace(/\\'/g, "'");
                            const isLiked = likedMovies.includes(movieTitle);
                            
                            if (isLiked) {
                                detailLikeBtn.innerHTML = `<i class="bi bi-heart-fill me-2"></i> Đã thích`;
                                detailLikeBtn.classList.add('btn-liked');
                            } else {
                                detailLikeBtn.innerHTML = `<i class="bi bi-heart-fill me-2"></i> Thích phim này`;
                                detailLikeBtn.classList.remove('btn-liked');
                            }
                            detailLikeBtn.disabled = false;
                        }
                    }
                })
                .catch(error => {
                    console.error("Lỗi khi cập nhật trạng thái nút thích:", error);
                });
        }

        // Hàm để lấy đề xuất phim mà không cần thích phim
        function getMovieRecommendations(title) {
            if (!currentUser) {
                alert('Bạn cần đăng nhập để xem đề xuất phim!');
                return;
            }
            
            showLoading();
            
            // Đóng modal chi tiết phim nếu đang mở
            const movieDetailModal = bootstrap.Modal.getInstance(document.getElementById('movieDetailModal'));
            if (movieDetailModal) {
                movieDetailModal.hide();
            }
            
            // Cập nhật trạng thái nút đề xuất
            const recommendBtn = event.target.closest('.recommend-btn');
            if (recommendBtn) {
                recommendBtn.innerHTML = `<i class="bi bi-hourglass-split"></i> Đang xử lý...`;
                recommendBtn.disabled = true;
            }
            
            fetch(API_RECOMMEND_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ movie_name: title })
            })
            .then(res => {
                if (!res.ok) {
                    throw new Error(`Lỗi máy chủ: ${res.status} ${res.statusText}`);
                }
                return res.json();
            })
            .then(data => {
                hideLoading();
                
                // Khôi phục trạng thái nút
                if (recommendBtn) {
                    recommendBtn.innerHTML = `<i class="bi bi-stars"></i> Đề xuất`;
                    recommendBtn.disabled = false;
                }
                
                // Hiện popup recommend nếu có dữ liệu
                if (data && data.recommendations && data.recommendations.length > 0) {
                    // Đảm bảo modal chi tiết đã được đóng hoàn toàn trước khi mở modal đề xuất
                    setTimeout(() => {
                        showRecommendPopup(data.recommendations);
                    }, 300);
                } else {
                    alert("Không có phim đề xuất nào cho phim này!");
                }
            })
            .catch(err => {
                console.error("Lỗi khi lấy đề xuất phim:", err);
                hideLoading();
                
                // Khôi phục trạng thái nút
                if (recommendBtn) {
                    recommendBtn.innerHTML = `<i class="bi bi-stars"></i> Đề xuất`;
                    recommendBtn.disabled = false;
                }
                
                alert(`Không thể lấy đề xuất phim: ${err.message}`);
            });
        }
    </script>
</body>
</html>
