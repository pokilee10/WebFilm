<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <title>KLiHoKa</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Bootstrap 5, Bootstrap Icons, Google Fonts -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>
</head>
<body>
    <div class="container py-4">
        <div class="main-title">
            <i class="bi bi-film"></i> KLiHoKa
        </div>
        <div class="user-info mb-3" id="userInfo" style="display:none;">
            üë§ Xin ch√†o, <span id="userEmail"></span>
            <button class="logout-btn" onclick="logout()">ƒêƒÉng xu·∫•t</button>
        </div>
        <div class="filter-bar row align-items-center mb-3">
            <div class="col-md-6">
                <label for="genreFilter" class="form-label mb-1">L·ªçc theo th·ªÉ lo·∫°i:</label>
                <select id="genreFilter" class="form-select">
                    <option value="">-- T·∫•t c·∫£ --</option>
                </select>
            </div>
            <div class="col-md-6">
                <label for="searchInput" class="form-label mb-1">T√¨m ki·∫øm phim:</label>
                <input type="text" id="searchInput" class="form-control" placeholder="Nh·∫≠p t√™n phim...">
            </div>
        </div>
        <div class="row mt-3" id="movieList"></div>
        <!-- Th√™m ph√¢n trang -->
        <div id="pagination" class="d-flex justify-content-center my-4">
            <button id="prevPage" class="btn btn-outline-primary me-2"><i class="bi bi-arrow-left"></i> Trang tr∆∞·ªõc</button>
            <div id="pageInfo" class="btn btn-light disabled">Trang <span id="currentPage">1</span> / <span id="totalPages">1</span></div>
            <button id="nextPage" class="btn btn-outline-primary ms-2">Trang sau <i class="bi bi-arrow-right"></i></button>
        </div>
    </div>

    <!-- Modal Recommend -->
    <div class="modal fade" id="recommendModal" tabindex="-1" aria-labelledby="recommendModalLabel" aria-hidden="true">
      <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
          <div class="modal-header" style="background: linear-gradient(90deg, #ff4081 60%, #ff8c00 100%); color: #fff;">
            <h5 class="modal-title" id="recommendModalLabel"><i class="bi bi-stars"></i> Phim G·ª£i √ù Cho B·∫°n</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="ƒê√≥ng"></button>
          </div>
          <div class="modal-body" id="recommendContent">
            <!-- N·ªôi dung phim g·ª£i √Ω s·∫Ω ƒë∆∞·ª£c render ·ªü ƒë√¢y -->
          </div>
        </div>
      </div>
    </div>

    <!-- Bootstrap JS (ƒë·ªÉ cu·ªëi body, cho modal ho·∫°t ƒë·ªông) -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <style>
        /* CSS cho poster phim */
        .movie-poster {
            height: 350px;
            object-fit: cover;
            object-position: center top;
            border-top-left-radius: calc(0.375rem - 1px);
            border-top-right-radius: calc(0.375rem - 1px);
            background-color: #232526;
        }
        /* CSS cho hi·ªÉn th·ªã phim trong popup g·ª£i √Ω */
        .recommend-card .movie-poster {
            height: 120px;
            width: 80px;
            object-fit: cover;
        }

        /* C·∫£i thi·ªán hi·ªÉn th·ªã danh s√°ch phim */
        .movie-card {
            margin-bottom: 20px;
        }
        .movie-card .card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            height: 100%;
            border: none;
            background-color: #232526ee;
            color: #fff;
        }
        .movie-card .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .movie-card .card-title {
            color: #ff4081;
            font-weight: bold;
            margin-bottom: 0.5rem;
            height: 2.5rem;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        .movie-card p {
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }
        .movie-card .overview {
            max-height: 80px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        /* N√∫t ph√¢n trang */
        #pagination {
            margin: 2rem 0;
        }
        #pagination button {
            background: linear-gradient(90deg, #ff4081 60%, #ff8c00 100%);
            border: none;
            color: white;
            padding: 8px 15px;
            transition: all 0.3s ease;
        }
        #pagination button:hover:not(:disabled) {
            background: linear-gradient(90deg, #ff8c00 0%, #ff4081 100%);
            transform: scale(1.05);
        }
        #pagination button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        #pageInfo {
            padding: 8px 15px;
        }

        /* C·∫£i thi·ªán hi·ªÉn th·ªã tr√™n thi·∫øt b·ªã di ƒë·ªông */
        @media (max-width: 767px) {
            .movie-poster {
                height: 300px;
            }
            .movie-card {
                padding-left: 10px;
                padding-right: 10px;
            }
            .filter-bar {
                margin-bottom: 1rem;
            }
        }
    </style>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDGn25lfLVLX2eahI41LTLFx9whEZrgRIk",
            authDomain: "web-phim-6b76c.firebaseapp.com",
            databaseURL: "https://web-phim-6b76c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "web-phim-6b76c",
            storageBucket: "web-phim-6b76c.appspot.com",
            messagingSenderId: "676922439385",
            appId: "1:676922439385:web:476eea9d5265771ce230c8",
            measurementId: "G-B6Y0DSKFV2"
        };

        if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();
        let currentUser = null;
        let allMovies = [];

        // TMDB API Key
        const TMDB_API_KEY = "bd65461464529e3a5e518979a7a6065c";
        const TMDB_API_READ_TOKEN = "eyJhbGciOiJIUzI1NiJ9.eyJhdWQiOiJiZDY1NDYxNDY0NTI5ZTNhNWU1MTg5NzlhN2E2MDY1YyIsIm5iZiI6MTc0NTY4MzM5MS4wMjgsInN1YiI6IjY4MGQwM2JmZDgwZmRmODJhN2VhYjM2YSIsInNjb3BlcyI6WyJhcGlfcmVhZCJdLCJ2ZXJzaW9uIjoxfQ.sAUfjHZ4WzXvgfZCUaLS1kS0mjbMt5vQ14sZPT8r4sY";

        const S3_CSV_URL = "https://lxl-bucket.s3.ap-southeast-1.amazonaws.com/tmdb_5000_movies.csv";
        const API_RECOMMEND_URL = "https://qrvat15p0k.execute-api.ap-southeast-1.amazonaws.com/default/film-recommend-system";

        auth.onAuthStateChanged(user => {
            currentUser = user;
            if (!user) {
                window.location.href = "login.html";
            } else {
                document.getElementById('userInfo').style.display = '';
                document.getElementById('userEmail').innerText = user.email;
                initPage(); // Kh·ªüi t·∫°o trang
            }
        });

        // H√†m kh·ªüi t·∫°o trang
        function initPage() {
            fetchCSVFromS3();
            
            // Th√™m s·ª± ki·ªán khi scroll ƒë·ªÉ t·∫£i poster 
            window.addEventListener('scroll', function() {
                // Ki·ªÉm tra c√°c poster visible v√† t·∫£i n·∫øu c·∫ßn
                document.querySelectorAll('.movie-poster[data-id]').forEach(img => {
                    if (isElementInViewport(img) && img.src.includes('placehold.co')) {
                        const movieId = img.getAttribute('data-id');
                        if (movieId) {
                            if (posterCache[movieId] && posterCache[movieId] !== 'loading' && posterCache[movieId] !== 'error') {
                                img.src = posterCache[movieId];
                            } else if (posterCache[movieId] !== 'loading') {
                                loadPosterById(movieId);
                            }
                        }
                    }
                });
            });
        }

        // Ki·ªÉm tra ph·∫ßn t·ª≠ c√≥ trong viewport kh√¥ng
        function isElementInViewport(el) {
            const rect = el.getBoundingClientRect();
            return (
                rect.top >= 0 &&
                rect.left >= 0 &&
                rect.bottom <= (window.innerHeight || document.documentElement.clientHeight) &&
                rect.right <= (window.innerWidth || document.documentElement.clientWidth)
            );
        }

        function logout() {
            auth.signOut();
            alert('ƒê√£ ƒëƒÉng xu·∫•t!');
            window.location.href = "login.html";
        }

        // Bi·∫øn to√†n c·ª•c cho ph√¢n trang
        let currentPage = 1;
        let moviesPerPage = 12;
        let filteredMovies = [];

        // Danh s√°ch cache l∆∞u URL poster ƒë√£ t·∫£i
        let posterCache = {};
        
        // Kh√¥i ph·ª•c cache t·ª´ localStorage n·∫øu c√≥
        try {
            const savedCache = localStorage.getItem('posterCache');
            if (savedCache) {
                posterCache = JSON.parse(savedCache);
                console.log('ƒê√£ kh√¥i ph·ª•c cache poster:', Object.keys(posterCache).length);
            }
        } catch (e) {
            console.error('L·ªói khi kh√¥i ph·ª•c cache:', e);
            posterCache = {};
        }

        // H√†m l∆∞u cache v√†o localStorage
        function savePosterCache() {
            try {
                localStorage.setItem('posterCache', JSON.stringify(posterCache));
            } catch (e) {
                console.error('L·ªói khi l∆∞u cache:', e);
            }
        }

        function fetchCSVFromS3() {
            fetch(S3_CSV_URL)
                .then(res => res.text())
                .then(csvText => {
                    const movies = parseCSV(csvText);
                    allMovies = movies;
                    filteredMovies = allMovies; // L∆∞u t·∫•t c·∫£ phim ƒë·ªÉ ph√¢n trang
                    renderMovies(filteredMovies);
                    setupPagination();
                })
                .catch(err => {
                    document.getElementById('movieList').innerHTML = `<div class="alert alert-danger">L·ªói t·∫£i d·ªØ li·ªáu: ${err.message}</div>`;
                });
        }

        function parseCSV(csvText) {
            const lines = csvText.trim().split('\n');
            const headers = parseCSVLine(lines[0]);
            const movies = [];
            
            try {
                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length < headers.length) {
                        console.log(`D√≤ng ${i} c√≥ d·ªØ li·ªáu kh√¥ng ƒë·∫ßy ƒë·ªß, b·ªè qua.`);
                        continue;
                    }
                    
                    const movie = {};
                    headers.forEach((header, index) => {
                        movie[header] = values[index] || '';
                    });
                    
                    // ƒê·∫£m b·∫£o id l√† s·ªë
                    if (movie.id) {
                        movie.id = parseInt(movie.id);
                    }
                    
                    try {
                        // X·ª≠ l√Ω chu·ªói JSON th·ªÉ lo·∫°i n·∫øu c√≥ 
                        if (movie.genres && movie.genres.includes('{')) {
                            const genresRaw = movie.genres.replace(/""/g, '"');
                            const genres = JSON.parse(genresRaw);
                            movie.genres_str = Array.isArray(genres)
                                ? genres.map(g => g.name).join(', ')
                                : '';
                        } else {
                            movie.genres_str = movie.genres || '';
                        }
                    } catch (e) {
                        console.log(`L·ªói x·ª≠ l√Ω th·ªÉ lo·∫°i phim ${movie.title}:`, e);
                        movie.genres_str = movie.genres || '';
                    }
                    
                    // ƒê·∫£m b·∫£o lu√¥n c√≥ ti√™u ƒë·ªÅ
                    movie.title = movie.title || movie.original_title || `Phim #${i}`;
                    movies.push(movie);
                }
            } catch (e) {
                console.error("L·ªói x·ª≠ l√Ω CSV:", e);
            }
            
            // Log ƒë·ªÉ debug
            if (movies.length > 0) {
                console.log("D·ªØ li·ªáu phim ƒë·∫ßu ti√™n:", movies[0]);
                console.log("T·ªïng s·ªë phim t·ª´ CSV:", movies.length);
            } else {
                console.error("Kh√¥ng c√≥ phim n√†o t·ª´ CSV");
            }
            
            return movies;
        }

        function parseCSVLine(line) {
            const result = [];
            let current = '';
            let inQuotes = false;
            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                const nextChar = line[i + 1];
                if (char === '"' && inQuotes && nextChar === '"') {
                    current += '"';
                    i++;
                } else if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    result.push(current);
                    current = '';
                } else {
                    current += char;
                }
            }
            result.push(current);
            return result;
        }

        // H√†m t·∫°o URL ·∫£nh ƒë·∫°i di·ªán cho phim
        function getMoviePosterUrl(movie) {
            // N·∫øu c√≥ poster_path h·ª£p l·ªá, s·ª≠ d·ª•ng TMDB (c·∫•u tr√∫c URL ch√≠nh x√°c)
            if (movie.poster_path && movie.poster_path.length > 3) {
                // ƒê·∫£m b·∫£o poster_path b·∫Øt ƒë·∫ßu b·∫±ng "/"
                const path = movie.poster_path.startsWith('/') ? movie.poster_path : '/' + movie.poster_path;
                return `https://image.tmdb.org/t/p/w500${path}`;
            }
            
            // N·∫øu c√≥ trong cache, s·ª≠ d·ª•ng URL t·ª´ cache
            if (movie.id && posterCache[movie.id] && posterCache[movie.id] !== 'loading' && posterCache[movie.id] !== 'error') {
                return posterCache[movie.id];
            }
            
            // N·∫øu phim c√≥ ID, l∆∞u v√†o cache v√† s·∫Ω t·∫£i poster sau
            if (movie.id) {
                // ƒê√°nh d·∫•u ƒë·ªÉ t·∫£i poster sau
                setTimeout(() => {
                    loadPosterById(movie.id);
                }, 100);
            }
            
            // Tr·∫£ v·ªÅ URL placeholder t·∫°m th·ªùi
            const placeholderText = encodeURIComponent(movie.title || "Kh√¥ng c√≥ t√™n");
            return `https://placehold.co/300x450/232526/ff4081?text=${placeholderText}`;
        }

        // H√†m t·∫£i v√† c·∫≠p nh·∫≠t poster b·∫±ng ID phim
        async function loadPosterById(movieId) {
            // N·∫øu ƒë√£ c√≥ trong cache v√† kh√¥ng ph·∫£i ƒëang t·∫£i, tr·∫£ v·ªÅ URL tr·ª±c ti·∫øp
            if (posterCache[movieId] && posterCache[movieId] !== 'loading' && posterCache[movieId] !== 'error') {
                return posterCache[movieId];
            }

            // N·∫øu ƒëang t·∫£i, b·ªè qua
            if (posterCache[movieId] === 'loading') {
                return null;
            }

            // ƒê√°nh d·∫•u trong cache ƒë·ªÉ tr√°nh t·∫£i l·∫°i nhi·ªÅu l·∫ßn
            posterCache[movieId] = 'loading';
            
            try {
                // G·ªçi API ƒë·ªÉ l·∫•y poster
                const posterUrl = await fetchMoviePoster(movieId);
                
                if (posterUrl) {
                    // C·∫≠p nh·∫≠t v√†o cache
                    posterCache[movieId] = posterUrl;
                    savePosterCache(); // L∆∞u v√†o localStorage
                    
                    // C·∫≠p nh·∫≠t t·∫•t c·∫£ poster c√≥ c√πng ID
                    document.querySelectorAll(`.movie-poster[data-id="${movieId}"]`).forEach(img => {
                        // Ch·ªâ c·∫≠p nh·∫≠t n·∫øu l√† placeholder
                        if (img.src.includes('placehold.co')) {
                            img.src = posterUrl;
                        }
                    });

                    return posterUrl;
                }
            } catch (error) {
                console.error(`L·ªói t·∫£i poster cho phim ID ${movieId}:`, error);
                posterCache[movieId] = 'error';
                savePosterCache(); // L∆∞u c·∫£ l·ªói v√†o cache
            }
            
            return null;
        }

        // H√†m ƒë·ªÉ th·ª≠ l·∫•y ·∫£nh t·ª´ OMDB API khi c·∫ßn
        function tryFetchPosterFromOMDB(movieTitle, imgElement) {
            // Kh√¥ng c·∫ßn n·ªØa, ƒë√£ s·ª≠ d·ª•ng TMDB API
        }

        // H√†m truy v·∫•n th√¥ng tin phim b·∫±ng TMDB API n·∫øu b·∫°n c√≥ API key
        function fetchTMDBPoster(movieId, imgElement) {
            // Kh√¥ng c·∫ßn n·ªØa, ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·∫±ng fetchMoviePoster
        }

        // H√†m ƒë·ªÉ c·ªë g·∫Øng l·∫•y poster t·ª´ TMDB API
        function loadBackupPosters() {
            // Kh√¥ng c·∫ßn n·ªØa, ƒë√£ ƒë∆∞·ª£c thay th·∫ø b·∫±ng loadPosterById
        }

        function renderMovies(movies) {
            const genreSet = new Set();
            movies.forEach(movie => {
                if (movie.genres_str) {
                    movie.genres_str.split(',').forEach(g => genreSet.add(g.trim()));
                }
            });

            const genreFilter = document.getElementById('genreFilter');
            genreFilter.innerHTML = `<option value="">-- T·∫•t c·∫£ --</option>`;
            Array.from(genreSet).sort().forEach(genre => {
                genreFilter.innerHTML += `<option value="${genre}">${genre}</option>`;
            });
            genreFilter.onchange = () => filterMovies();
            document.getElementById('searchInput').oninput = () => filterMovies();

            // Hi·ªÉn th·ªã phim cho trang hi·ªán t·∫°i
            displayCurrentPage();
        }

        function filterMovies() {
            const genre = document.getElementById('genreFilter').value.trim();
            const keyword = document.getElementById('searchInput').value.toLowerCase();
            
            filteredMovies = allMovies.filter(movie => {
                const matchGenre = !genre || movie.genres_str.split(',').map(g => g.trim()).includes(genre);
                const matchKeyword = !keyword || movie.title.toLowerCase().includes(keyword);
                return matchGenre && matchKeyword;
            });
            
            // Reset v·ªÅ trang 1 khi l·ªçc
            currentPage = 1;
            displayCurrentPage();
            setupPagination();
        }

        function displayCurrentPage() {
            const startIndex = (currentPage - 1) * moviesPerPage;
            const endIndex = startIndex + moviesPerPage;
            const moviesToDisplay = filteredMovies.slice(startIndex, endIndex);
            
            renderMovieList(moviesToDisplay);
            
            // C·∫≠p nh·∫≠t th√¥ng tin trang
            document.getElementById('currentPage').textContent = currentPage;
            document.getElementById('totalPages').textContent = Math.ceil(filteredMovies.length / moviesPerPage);
            
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i n√∫t ph√¢n trang
            document.getElementById('prevPage').disabled = currentPage === 1;
            document.getElementById('nextPage').disabled = currentPage >= Math.ceil(filteredMovies.length / moviesPerPage);
        }

        function setupPagination() {
            document.getElementById('prevPage').onclick = () => {
                if (currentPage > 1) {
                    currentPage--;
                    displayCurrentPage();
                    window.scrollTo(0, 0);
                }
            };
            
            document.getElementById('nextPage').onclick = () => {
                const totalPages = Math.ceil(filteredMovies.length / moviesPerPage);
                if (currentPage < totalPages) {
                    currentPage++;
                    displayCurrentPage();
                    window.scrollTo(0, 0);
                }
            };
            
            // Hi·ªÉn th·ªã t·ªïng s·ªë trang
            document.getElementById('totalPages').textContent = Math.ceil(filteredMovies.length / moviesPerPage);
        }

        function renderMovieList(movies) {
            const container = document.getElementById('movieList');
            container.innerHTML = '';
            const movieIds = [];
            
            movies.forEach(movie => {
                // L·∫•y URL poster
                let posterUrl = getMoviePosterUrl(movie);
                
                // Th√™m ID v√†o danh s√°ch c·∫ßn t·∫£i (n·∫øu ch∆∞a c√≥ poster)
                if (movie.id && (!posterCache[movie.id] || posterCache[movie.id] === 'error')) {
                    movieIds.push(movie.id);
                }
                
                // C·∫Øt ng·∫Øn m√¥ t·∫£ phim
                let overview = movie.overview || '';
                const shortOverview = overview.length > 100 ? 
                    overview.substring(0, 100) + '...' : overview;
                
                const col = document.createElement('div');
                col.className = 'col-md-6 col-lg-4 movie-card';
                col.innerHTML = `
                    <div class="card shadow-sm h-100">
                        <img src="${posterUrl}" class="card-img-top movie-poster" alt="${movie.title}" data-id="${movie.id || ''}" 
                             onerror="this.onerror=null; if(this.src !== 'https://placehold.co/300x450/232526/ff4081?text=${encodeURIComponent(movie.title)}') this.src='https://placehold.co/300x450/232526/ff4081?text=${encodeURIComponent(movie.title)}'" 
                             loading="lazy">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title"><i class="bi bi-film"></i> ${movie.title}</h5>
                            <p><strong>Th·ªÉ lo·∫°i:</strong> ${movie.genres_str}</p>
                            <p><strong>Ng√†y ph√°t h√†nh:</strong> ${movie.release_date || 'Kh√¥ng r√µ'}</p>
                            <p><strong>ƒêi·ªÉm ƒë√°nh gi√°:</strong> <span class="text-warning">${movie.vote_average || '?'}</span></p>
                            <p class="overview">${shortOverview || 'Kh√¥ng c√≥ m√¥ t·∫£'}</p>
                            <button class="like-btn mt-auto" onclick="likeMovie('${movie.title.replace(/'/g, "\\'")}')">
                                <i class="bi bi-heart-fill"></i> Th√≠ch
                            </button>
                        </div>
                    </div>
                `;
                container.appendChild(col);
            });
        }

        // H√†m ki·ªÉm tra v√† t·∫£i l·∫°i poster t·ª´ cache sau khi t·∫£i trang
        function reloadPostersFromCache() {
            document.querySelectorAll('.movie-poster[data-id]').forEach(img => {
                const movieId = img.getAttribute('data-id');
                if (movieId && img.src.includes('placehold.co')) {
                    if (posterCache[movieId] && posterCache[movieId] !== 'loading' && posterCache[movieId] !== 'error') {
                        img.src = posterCache[movieId];
                    }
                }
            });
        }
        
        // ƒêƒÉng k√Ω s·ª± ki·ªán reload
        window.addEventListener('load', reloadPostersFromCache);

        function likeMovie(title) {
            if (!currentUser) {
                alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch phim!');
                return;
            }
            fetch(API_RECOMMEND_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ movie_name: title })
            })
            .then(res => res.json())
            .then(data => {
                // L∆∞u phim ƒë√£ th√≠ch v√†o Firebase
                const userId = currentUser.uid;
                const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
                userMoviesRef.once('value').then(snapshot => {
                    let liked = snapshot.val() || [];
                    if (!liked.includes(title)) {
                        liked.push(title);
                        userMoviesRef.set(liked);
                    }
                });
                // Hi·ªán popup recommend
                showRecommendPopup(data.recommendations || []);
            })
            .catch(err => {
                alert("Kh√¥ng th·ªÉ l·∫•y phim g·ª£i √Ω.");
            });
        }

        function showRecommendPopup(recommendTitles) {
          const content = document.getElementById('recommendContent');
          if (recommendTitles.length === 0) {
            content.innerHTML = `<div class="alert alert-warning">Kh√¥ng c√≥ phim g·ª£i √Ω.</div>`;
          } else {
            // L·∫•y th√¥ng tin chi ti·∫øt phim t·ª´ allMovies (n·∫øu c√≥)
            const recommendMovies = recommendTitles.map(title =>
              allMovies.find(m => m.title === title)
              || { title, genres_str: '', release_date: '', vote_average: '', overview: '', poster_path: '', id: '' }
            );

            content.innerHTML = `
              <div class="recommend-list">
                ${recommendMovies.map(movie => {
                    // L·∫•y URL poster
                    let posterUrl = getMoviePosterUrl(movie);
                    
                    // C·∫Øt ng·∫Øn m√¥ t·∫£ phim
                    let overview = movie.overview || '';
                    const shortOverview = overview.length > 100 ? 
                        overview.substring(0, 100) + '...' : overview;
                    
                    return `
                      <div class="card recommend-card mb-3 shadow border-0">
                        <div class="card-body d-flex flex-column flex-md-row align-items-md-center">
                          <img src="${posterUrl}" class="movie-poster me-3" alt="${movie.title}" data-id="${movie.id || ''}"
                               onerror="this.onerror=null; this.src='https://placehold.co/300x450/232526/ff4081?text=${encodeURIComponent(movie.title)}'"
                               loading="lazy">
                          <div class="flex-fill">
                            <h6 class="card-title mb-2 text-pink"><i class="bi bi-film"></i> ${movie.title}</h6>
                            <p class="mb-1"><strong>Th·ªÉ lo·∫°i:</strong> ${movie.genres_str || '<span class="text-muted">Kh√¥ng r√µ</span>'}</p>
                            <p class="mb-1"><strong>Ng√†y ph√°t h√†nh:</strong> ${movie.release_date || '<span class="text-muted">Kh√¥ng r√µ</span>'}</p>
                            <p class="mb-1"><strong>ƒêi·ªÉm ƒë√°nh gi√°:</strong> <span class="text-warning">${movie.vote_average || '?'}</span></p>
                            <p class="mb-2 overview">${shortOverview || '<span class="text-muted">Kh√¥ng c√≥ m√¥ t·∫£</span>'}</p>
                          </div>
                          <div class="ms-md-3 mt-3 mt-md-0">
                            <button class="btn btn-outline-primary" onclick="likeMovieFromRecommend('${movie.title.replace(/'/g, "\\'")}')">
                              <i class="bi bi-heart"></i> Th√™m v√†o danh s√°ch y√™u th√≠ch
                            </button>
                          </div>
                        </div>
                      </div>
                    `;
                }).join('')}
              </div>
            `;
          }
          // Hi·ªán modal
          const modal = new bootstrap.Modal(document.getElementById('recommendModal'));
          modal.show();
        }

        // H√†m n√†y ƒë·ªÉ th√™m phim v√†o danh s√°ch y√™u th√≠ch t·ª´ popup (n·∫øu mu·ªën)
        function likeMovieFromRecommend(title) {
          if (!currentUser) {
            alert('B·∫°n c·∫ßn ƒëƒÉng nh·∫≠p ƒë·ªÉ th√≠ch phim!');
            return;
          }
          const userId = currentUser.uid;
          const userMoviesRef = db.ref('users/' + userId + '/liked_movies');
          userMoviesRef.once('value').then(snapshot => {
            let liked = snapshot.val() || [];
            if (!liked.includes(title)) {
              liked.push(title);
              userMoviesRef.set(liked);
              alert("ƒê√£ th√™m v√†o danh s√°ch y√™u th√≠ch!");
            } else {
              alert("Phim n√†y ƒë√£ c√≥ trong danh s√°ch y√™u th√≠ch c·ªßa b·∫°n!");
            }
          });
        }

        // ƒê·∫£m b·∫£o ID l√† s·ªë khi so s√°nh
        function parseMovieId(id) {
            try {
                return parseInt(id);
            } catch {
                return 0;
            }
        }

        // H√†m ƒë·ªÉ l·∫•y poster phim t·ª´ API TMDB
        async function fetchMoviePoster(movieId) {
            try {
                const response = await fetch(`https://api.themoviedb.org/3/movie/${movieId}?api_key=${TMDB_API_KEY}`);
                const data = await response.json();
                
                if (data.poster_path) {
                    return `https://image.tmdb.org/t/p/w500${data.poster_path}`;
                }
                return null;
            } catch (error) {
                console.error(`L·ªói khi l·∫•y th√¥ng tin phim ${movieId}:`, error);
                return null;
            }
        }

        // Th√™m s·ª± ki·ªán ƒë·ªÉ t·∫£i l·∫°i poster khi tr·ªü l·∫°i trang
        window.addEventListener('pageshow', function(event) {
            // T·∫£i l·∫°i poster khi quay l·∫°i trang (s·ª≠ d·ª•ng cache n·∫øu c√≥)
            if (event.persisted) {
                console.log('Trang ƒë∆∞·ª£c kh√¥i ph·ª•c t·ª´ cache tr√¨nh duy·ªát, t·∫£i l·∫°i poster');
                setTimeout(() => {
                    document.querySelectorAll('.movie-poster[data-id]').forEach(img => {
                        const movieId = img.getAttribute('data-id');
                        if (movieId && img.src.includes('placehold.co')) {
                            if (posterCache[movieId] && posterCache[movieId] !== 'loading' && posterCache[movieId] !== 'error') {
                                img.src = posterCache[movieId];
                            } else {
                                loadPosterById(movieId);
                            }
                        }
                    });
                }, 300);
            }
        });
    </script>
</body>
</html>
